---
# LE Practice Title
title: "Weekly Numbers Practice"
output:
  html_document:
    df_print: paged
  word_document:
    fig_caption: yes
    fig_height: 5
    fig_width: 8
header-includes:
- \usepackage{booktabs}
- \usepackage{longtable}
- \usepackage{array}
- \usepackage{multirow}
- \usepackage{wrapfig}
- \usepackage{float}
- \usepackage{colortbl}
- \usepackage{pdflscape}
- \usepackage{tabu}
- \usepackage{threeparttable}
- \usepackage{threeparttablex}
- \usepackage[normalem]{ulem}
- \usepackage{makecell}
- \usepackage{xcolor}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# !diagnostics off
```

```{r echo=FALSE, warning=FALSE, message=FALSE, results="hide" }

# # directories -------------------------------------------------------------
# 
# computer = 'pc' # set this to either 'mac' or 'pc' (Georgia = W:/ as I have string mounted differently)
# 
# if (computer=="pc") {
#   string = 'W:/string-mbd/'
#   sdan1 = 'Y:/sdan1/'
# } else if (computer=="mac") {
#   string = '/Volumes/string-mbd/'
#   sdan1 = '/Volumes/sdan1/'
# }
# 
# database_location = paste0(string, "Database/Master Psychometric Database/") # tasks database also located here
# IRTA_tracker_location = paste0(string, "Database/Master Participant Tracker/")
# weekly_numbers_location = paste0(string, "Minutes and conversation archives/Weekly Meeting Sheet/")
# CBT_location = paste0(string, "Database/Master Psychometric Database/CBT/")
# scripts = paste0(string, "Database/Database_Scripts_Github/") # temp useful directory while scripts are still under development
# 
# # packages ----------------------------------------------------------------
# 
# suppressPackageStartupMessages(library(readxl))
# suppressPackageStartupMessages(library(writexl))
# suppressPackageStartupMessages(library(tidyr))
# suppressPackageStartupMessages(library(dplyr))
# suppressPackageStartupMessages(library(rmarkdown))
# suppressPackageStartupMessages(library(eeptools))
# suppressPackageStartupMessages(library(summarytools))
# suppressPackageStartupMessages(library(openxlsx))
# suppressPackageStartupMessages(library(data.table))
# suppressPackageStartupMessages(library(reshape2))
# suppressPackageStartupMessages(library(stringr))
# suppressPackageStartupMessages(library(lubridate))
# suppressPackageStartupMessages(library(ggplot2))
# suppressPackageStartupMessages(library(rlang))
# suppressPackageStartupMessages(library(purrr))
# suppressPackageStartupMessages(library(tidyverse))
# suppressPackageStartupMessages(library(shiny))
# suppressPackageStartupMessages(library(knitr))
# suppressPackageStartupMessages(library(kableExtra))
# 
# # other to load if running script here ------------------------------------
# 
# to_change <- read_excel(paste0(scripts, "to_change_before_running_master_script.xlsx"))
# max_tasks <- c(to_change$max_tasks)
# # todays_date_formatted <- c(to_change$todays_date_formatted)
# # todays_date_formatted <- as.Date(todays_date_formatted)
# todays_date_formatted <- as.Date("2019-12-13")
# last_week_date_formatted <- todays_date_formatted - as.difftime(7, unit="days")

```

```{r echo=FALSE, warning=FALSE, message=FALSE, results="hide" }
# Loading data ------------------------------------------------------------
todays_date <- todays_date_formatted %>% format(., "%B %d %Y")
last_week_date <- last_week_date_formatted %>% format(., "%B %d %Y")
two_weeks_date_formatted <- todays_date_formatted - as.difftime(14, unit="days")
Psychometrics_date <- substring(latest_sdq_pull, 7, 16)

if (exists("task_reshape_master_QC")==FALSE) {
        task_master_file <- list.files(path = paste0(IRTA_tracker_location), pattern = "^TASKS_DATABASE_QC", all.files = FALSE,
                                 full.names = FALSE, recursive = FALSE, ignore.case = FALSE, include.dirs = FALSE, no.. = FALSE)
        task_master_file_time <- file.mtime(paste0(IRTA_tracker_location, "/", task_master_file)) %>% as.Date()
        task_master_combined <- tibble(File=c(task_master_file), Date=c(task_master_file_time)) %>% arrange(desc(Date)) %>% slice(1)
        task_reshape_master_QC <- read_excel(paste0(IRTA_tracker_location, task_master_combined[1]))
        date_variabes <- c("DOB", "Overall_date", "Task_Date")
        numeric_variables <- c("Task_Number")
        task_reshape_master_QC[date_variabes] <- lapply(task_reshape_master_QC[date_variabes], as.Date) 
        task_reshape_master_QC[numeric_variables] <- lapply(task_reshape_master_QC[numeric_variables], as.numeric) 
        rm(date_variabes, task_master_file, task_master_file_time, task_master_combined)
} else {
        print("master IRTA tracker + QC info already imported")
        numeric_variables <- c("Task_Number")
        task_reshape_master_QC[numeric_variables] <- lapply(task_reshape_master_QC[numeric_variables], as.numeric) 
}

if (exists("master_IRTA_latest")==FALSE) {
        irta_master_file <- list.files(path = paste0(IRTA_tracker_location), pattern = "^MASTER_IRTA_DATABASE", all.files = FALSE,
                                 full.names = FALSE, recursive = FALSE, ignore.case = FALSE, include.dirs = FALSE, no.. = FALSE)
        irta_master_file_time <- file.mtime(paste0(IRTA_tracker_location, "/", irta_master_file)) %>% as.Date()
        irta_master_combined <- tibble(File=c(irta_master_file), Date=c(irta_master_file_time)) %>% arrange(desc(Date)) %>% slice(1)
        master_IRTA_latest <- read_excel(paste0(IRTA_tracker_location, irta_master_combined[1]))
        date_variabes <- c("DOB", "Screening_Start_Date", "Referral_Date", "Consent_Date", "Clinical_Visit_Date", "Clinicals_date", "Overall_date")
        for(i in seq_len(max_tasks)) { date_variabes <- c(date_variabes, paste0("Task", i, "_Date"))}
        master_IRTA_latest[date_variabes] <- lapply(master_IRTA_latest[date_variabes], as.Date)
        rm(i, date_variabes, irta_master_file, irta_master_file_time, irta_master_combined)
} else {
    print("master IRTA tracker already imported")
}

if (exists("master_IRTA_oldest_screens_latest")==FALSE) {
        irta_old_screens_file <- list.files(path = paste0(IRTA_tracker_location), pattern = "^OLD_REFERRALS_DATABASE", all.files = FALSE,
                                 full.names = FALSE, recursive = FALSE, ignore.case = FALSE, include.dirs = FALSE, no.. = FALSE)
        irta_old_screens_file_time <- file.mtime(paste0(IRTA_tracker_location, "/", irta_old_screens_file)) %>% as.Date()
        irta_old_screens_combined <- tibble(File=c(irta_old_screens_file), Date=c(irta_old_screens_file_time)) %>% arrange(desc(Date)) %>% slice(1)
        master_IRTA_oldest_screens_latest <- read_excel(paste0(IRTA_tracker_location, irta_old_screens_combined[1]))
        date_variabes <- c("DOB", "Screening_Start_Date", "Referral_Date", "Consent_Date", "Clinical_Visit_Date", "Clinicals_date", "Overall_date")
        master_IRTA_oldest_screens_latest[date_variabes] <- lapply(master_IRTA_oldest_screens_latest[date_variabes], as.Date) 
        rm(date_variabes, irta_old_screens_file, irta_old_screens_file_time, irta_old_screens_combined)
} else {
    print("IRTA tracker screens OLD already imported")
}

if (exists("master_IRTA_screens_latest")==FALSE) {
        irta_ongoing_screens_file <- list.files(path = paste0(IRTA_tracker_location), pattern = "^REFERRAL_AND_SCREENING_DATABASE", all.files = FALSE,
                                 full.names = FALSE, recursive = FALSE, ignore.case = FALSE, include.dirs = FALSE, no.. = FALSE)
        irta_ongoing_screens_file_time <- file.mtime(paste0(IRTA_tracker_location, "/", irta_ongoing_screens_file)) %>% as.Date()
        irta_ongoing_screens_combined <- tibble(File=c(irta_ongoing_screens_file), Date=c(irta_ongoing_screens_file_time)) %>% 
          arrange(desc(Date)) %>% slice(1)
        master_IRTA_screens_latest <- read_excel(paste0(IRTA_tracker_location, irta_ongoing_screens_combined[1]))
        date_variabes <- c("DOB", "Screening_Start_Date", "Referral_Date", "Consent_Date", "Clinical_Visit_Date", "Clinicals_date", "Overall_date")
        master_IRTA_screens_latest[date_variabes] <- lapply(master_IRTA_screens_latest[date_variabes], as.Date) 
        rm(date_variabes, irta_ongoing_screens_file, irta_ongoing_screens_file_time, irta_ongoing_screens_combined)
} else {
    print("IRTA tracker screens current already imported")
}

if (exists("Psychometrics_treatment")==FALSE) {
        master_database_file <- list.files(path = paste0(database_location), pattern = "^MASTER_DATABASE_CLINICAL", all.files = FALSE,
                                 full.names = FALSE, recursive = FALSE, ignore.case = FALSE, include.dirs = FALSE, no.. = FALSE)
        master_database_file_time <- file.mtime(paste0(database_location, "/", master_database_file)) %>% as.Date()
        master_database_combined <- tibble(File=c(master_database_file), Date=c(master_database_file_time)) %>% 
          arrange(desc(Date)) %>% slice(1)
        Psychometrics_treatment <- read_excel(paste0(database_location, master_database_combined[1]))
        family_hist <- Psychometrics_treatment %>% select(Initials, IRTA_tracker, c_ksadsdx_primary_dx, c_family_interview_date, 
                         c_family_interview_interviewer, c_family_interview_type) %>% filter(!is.na(c_family_interview_interviewer)) %>% group_by(Initials) %>% 
          arrange(Initials, c_family_interview_date) %>% slice(n()) %>% ungroup()
        crisis <- Psychometrics_treatment %>% select(Initials, IRTA_tracker, Clinical_Visit_Date, c_ksadsdx_primary_dx, c_ksadsdx_dx_detailed,
                 s_crisis_base_date, s_crisis_fu_date, s_crisis_3m_tot, s_crisis_base_tot, s_crisis_fu_tot, 
                 p_crisis_base_date, p_crisis_fu_date, p_crisis_3m_tot, p_crisis_base_tot, p_crisis_fu_tot, 
                 s_mfq1w_tot, p_mfq1w_tot, s_mfq_tot, p_mfq_tot, s_crisis_base_1_exposed, s_crisis_base_2_self_diagnosis, 
                 s_crisis_fu_1_exposed, s_crisis_fu_2_self_diagnosis) %>% 
          filter(!is.na(s_crisis_base_tot) | !is.na(s_crisis_fu_tot) | !is.na(s_mfq1w_tot)  | !is.na(s_mfq_tot) | 
                   !is.na(p_crisis_base_tot) | !is.na(p_crisis_fu_tot) | !is.na(p_mfq1w_tot)  | !is.na(p_mfq_tot))
        rm(master_database_file, master_database_file_time, master_database_combined)
} else {
        print("clinical database info already imported")
        family_hist <- Psychometrics_treatment %>% select(Initials, IRTA_tracker, c_ksadsdx_primary_dx, c_family_interview_date, 
                         c_family_interview_interviewer, c_family_interview_type) %>% filter(!is.na(c_family_interview_interviewer)) %>% group_by(Initials) %>% 
          arrange(Initials, c_family_interview_date) %>% slice(n()) %>% ungroup()
        crisis <- Psychometrics_treatment %>% select(Initials, IRTA_tracker, Clinical_Visit_Date, c_ksadsdx_primary_dx, c_ksadsdx_dx_detailed,
                 s_crisis_base_date, s_crisis_fu_date, s_crisis_3m_tot, s_crisis_base_tot, s_crisis_fu_tot, 
                 p_crisis_base_date, p_crisis_fu_date, p_crisis_3m_tot, p_crisis_base_tot, p_crisis_fu_tot, 
                 s_mfq1w_tot, p_mfq1w_tot, s_mfq_tot, p_mfq_tot, s_crisis_base_1_exposed, s_crisis_base_2_self_diagnosis, 
                 s_crisis_fu_1_exposed, s_crisis_fu_2_self_diagnosis) %>% 
          filter(!is.na(s_crisis_base_tot) | !is.na(s_crisis_fu_tot) | !is.na(s_mfq1w_tot)  | !is.na(s_mfq_tot) | 
                   !is.na(p_crisis_base_tot) | !is.na(p_crisis_fu_tot) | !is.na(p_mfq1w_tot)  | !is.na(p_mfq_tot))
}

if (exists("Psychometrics_behav")==FALSE) {
        master_database_file <- list.files(path = paste0(database_location), pattern = "^MASTER_DATABASE_BEHAVIOURAL", all.files = FALSE,
                                 full.names = FALSE, recursive = FALSE, ignore.case = FALSE, include.dirs = FALSE, no.. = FALSE)
        master_database_file_time <- file.mtime(paste0(database_location, "/", master_database_file)) %>% as.Date()
        master_database_combined <- tibble(File=c(master_database_file), Date=c(master_database_file_time)) %>% 
          arrange(desc(Date)) %>% slice(1)
        Psychometrics_behav <- read_excel(paste0(database_location, master_database_combined[1]))
        date_variables <- Psychometrics_behav %>% select(matches("_date"), matches("_Date")) %>% colnames()
        Psychometrics_behav[date_variables] <- lapply(Psychometrics_behav[date_variables], as.Date)
        rm(master_database_file, master_database_file_time, master_database_combined)
} else {
        print("tasks database info already imported")
        }

if (exists("MEG_mprage")==FALSE) {
        meg_mprage_file <- list.files(path = paste0(IRTA_tracker_location, "QCing/"), pattern = "^MEG_need_mprage", all.files = FALSE,
                                 full.names = FALSE, recursive = FALSE, ignore.case = FALSE, include.dirs = FALSE, no.. = FALSE)
        meg_mprage_file_time <- file.mtime(paste0(IRTA_tracker_location, "QCing/", meg_mprage_file)) %>% as.Date()
        meg_mprage_combined <- tibble(File=c(meg_mprage_file), Date=c(meg_mprage_file_time)) %>% 
          arrange(desc(Date)) %>% slice(1)
        MEG_mprage <- read_excel(paste0(IRTA_tracker_location, "QCing/", meg_mprage_combined[1]))
        
} else {
        print("MEG MPRAGE missing info already imported")
}

if (exists("MMI_recovery_combined2")==FALSE) {
        mmi_recovery_file <- list.files(path = paste0(database_location, "COVID19/"), pattern = "^MMI_recovery_subset", all.files = FALSE,
                                 full.names = FALSE, recursive = FALSE, ignore.case = FALSE, include.dirs = FALSE, no.. = FALSE)
        mmi_recovery_file_time <- file.mtime(paste0(database_location, "COVID19/", mmi_recovery_file)) %>% as.Date()
        mmi_recovery_combined <- tibble(File=c(mmi_recovery_file), Date=c(mmi_recovery_file_time)) %>% 
          arrange(desc(Date)) %>% slice(1)
        MMI_recovery_combined2 <- read_excel(paste0(database_location, "COVID19/", mmi_recovery_combined[1]))
} else {
        print("MMI recovery completion info already imported")
}

```

![](`r paste0("../", "images/NIH_logo.png")`)

***

#### WEDNESDAY RESEARCH MEETING: NUMBERS

***

##### DATE: `r todays_date`

***

#### Outline:

1. Recruitment & retention summary
    + Referrals
    + Screening status update  
    + Scheduling 
    + 18-M-0037 enrollment 
    + Longitudinal clinical follow ups
2. Task numbers
    + MID
    + SUPREME
    + MEG
    + Bloods 
    + Family History Interview
    + CRISIS questionnaire numbers
    + MMI_recovery numbers (PsychoPy task online)
3. Treatment
    + Outpatients
    + Inpatients 

***

#### 1. Recruitment summary

***

##### Referrals:

Referrals since last week, `r last_week_date`

```{r echo=FALSE, warning=FALSE, message=FALSE, results="hide" }

######## Dummy table
referrals_table_dummy <- tibble(Participant_Type2=c("HV", "MDD", "UNSURE", "Total", NA, "HV", "MDD", "UNSURE", "Total", NA, "HV", "MDD", "UNSURE", "Total", NA, 
                                "HV", "MDD", "UNSURE", "Total", NA), Screening_Successful=c("0","0","0","0","0", "1","1","1","1","1", "Total","Total","Total",
                                "Total","Total", NA,NA,NA,NA,NA), Freq=c("0")) %>% mutate(Screening_Successful=as.character(Screening_Successful), Freq=as.numeric(Freq))

######## Real table
referrals_last_week <- master_IRTA_screens_latest %>% select(Participant_Type2, Referral_Date, Screening_initial_contact_successful)
referrals_last_week$TDiff <- as.numeric(difftime(referrals_last_week$Referral_Date, last_week_date_formatted, tz="", units = "days"))
num_referrals2 <- referrals_last_week %>% filter(TDiff >=0)
referrals_table <- ctable(num_referrals2$Participant_Type2, num_referrals2$Screening_initial_contact_successful, 
                  useNA = "always", prop="r", totals=FALSE, display.type=FALSE) %>%
  as.data.frame()  %>% rename(Freq = "cross_table.Freq") %>% rename(Participant_Type2 = "cross_table.num_referrals2.Participant_Type2") %>%
  rename(Screening_Successful = "cross_table.num_referrals2.Screening_initial_contact_successful") %>% select(-proportions.Total, -proportions..NA.) %>% 
  mutate(Participant_Type2=as.character(Participant_Type2)) %>% mutate(Screening_Successful=as.character(Screening_Successful))
referrals_table <- na_if(referrals_table, "<NA>")

######## Combined table
referrals_table <- merge.default(referrals_table, referrals_table_dummy, all=TRUE) %>% 
 group_by(Participant_Type2, Screening_Successful) %>% arrange(desc(Freq)) %>% slice(1) %>% ungroup()
referrals_table$Screening_Successful <- replace_na(referrals_table$Screening_Successful, "Missing")

######## Table to print
referrals_table2 <- pivot_wider(referrals_table, id_cols = "Participant_Type2", names_from = "Screening_Successful", values_from = "Freq") %>% 
  rename(Unsuccessful="0") %>%   rename(Successful="1")
referrals_table2[,2:ncol(referrals_table2)] <- lapply(referrals_table2[,2:ncol(referrals_table2)], replace_na, "0")
referrals_table2[,2:ncol(referrals_table2)] <- lapply(referrals_table2[,2:ncol(referrals_table2)], as.numeric)

referrals_table2 <- referrals_table2 %>% mutate(Unsuccessful_Percent = ((Unsuccessful/Total) * 100)) %>% mutate(Unsuccessful_Percent = round(Unsuccessful_Percent, 2)) %>% 
  mutate(Successful_Percent = ((Successful/Total) * 100)) %>% mutate(Successful_Percent = round(Successful_Percent, 2)) %>% 
  mutate(Missing_Percent = ((Missing/Total) * 100)) %>% mutate(Missing_Percent = round(Missing_Percent, 2)) %>% 
  select(Participant_Type2, Successful, Successful_Percent, Unsuccessful, Unsuccessful_Percent, Missing, Missing_Percent, Total)
referrals_table2[,2:ncol(referrals_table2)] <- lapply(referrals_table2[,2:ncol(referrals_table2)], replace_na, "0")
referrals_table2$Participant_Type2 <- gsub("Total", "TOTAL", referrals_table2$Participant_Type2)

######## Variables to remove
rm(referrals_table_dummy, referrals_last_week, num_referrals2, referrals_table)

```

```{r echo=FALSE, warning=FALSE, message=FALSE}
    
referrals_table2 %>% arrange(Successful) %>% kable(., col.names = c("Diagnosis", "Contact Successful", "%", "Did not respond", "%", "Not recorded", "%", "Total")) %>% 
  kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

```

Referrals since BSC cut-off, November 30th 2018

```{r echo=FALSE, warning=FALSE, message=FALSE, results="hide" }

MDD_postcards <- tibble(date=c("2019-02-08", "2019-09-20", "2020-01-17", "2020-09-18")) %>% mutate(date = as.Date(date))
HV_postcards <- tibble(date=c("2019-04-26", "2019-07-08")) %>% mutate(date = as.Date(date))

suppressWarnings(source(paste0(scripts, 'Other_functions/Referrals_summary.R'), local=TRUE))

```

By 3-month period

```{r echo=FALSE, warning=FALSE, message=FALSE}
    
summary_3months %>% kable(., col.names = c("Quarter", "Starting", "Ending", "Diagnosis", "Number of referrals in period")) %>%
  kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

```

By mail out period

```{r echo=FALSE, warning=FALSE, message=FALSE}
    
summary_mail_periods %>% kable(., col.names = c("Diagnosis", "Description", "Number of referrals in period")) %>%
  kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

```

Graph showing number of referrals since last BSC, with postcard mail-outs denoted

```{r echo=FALSE, warning=FALSE, message=FALSE, fig.width=12, fig.height=8}

referrals_final %>%
  ggplot(aes(x = Date, y = Freq, group = Participant_Type2, color = Participant_Type2)) +
  geom_point(size=3) +
  geom_line(size=0.25) +
  scale_colour_manual(values = c("#FF0066","#000000")) +
  scale_x_date(date_break = "2 months", date_labels = "%b-%y") +
  scale_y_continuous(expand = c(0, 1)) +
  geom_vline(xintercept = (HV_postcards$date), size=1, colour="#FF0000") +
  geom_vline(xintercept = (MDD_postcards$date), size=1, colour="#000000") +
  geom_text(aes(x=as.Date("2019-02-08"), label="189,000\n", y=22), colour="#000000", angle=90, text=element_text(size=10)) +
  geom_text(aes(x=as.Date("2019-04-26"), label="108,000\n", y=22), colour="#FF0000", angle=90, text=element_text(size=10)) +
  geom_text(aes(x=as.Date("2019-07-08"), label="50,000\n", y=22), colour="#FF0000", angle=90, text=element_text(size=10)) +
  geom_text(aes(x=as.Date("2019-09-20"), label="150,000\n", y=22), colour="#000000", angle=90, text=element_text(size=10)) +
  geom_text(aes(x=as.Date("2020-01-17"), label="150,000\n", y=22), colour="#000000", angle=90, text=element_text(size=10)) +
  geom_text(aes(x=as.Date("2020-09-18"), label="150,000\n", y=22), colour="#000000", angle=90, text=element_text(size=10)) +
  theme_classic() + ylab("Number of referrals\n") + xlab("\nDate\n") + labs(color = "Diagnosis") +
  theme(axis.text.x = element_text(size=13), axis.text.y = element_text(size=13), 
        axis.title.x = element_text(size = 16), axis.title.y = element_text(size = 16))

```

***

##### Screening:

Overview: all participants still in active screening

```{r echo=FALSE, warning=FALSE, message=FALSE, results="hide" }

######## Dummy table
screens_dummy <- tibble(Participant_Type2=c("HV", "MDD", "UNSURE", "Total", NA, "HV", "MDD", "UNSURE", "Total", NA, 
  "HV", "MDD", "UNSURE", "Total", NA, "HV", "MDD", "UNSURE", "Total", NA, "HV", "MDD", "UNSURE", "Total", NA, 
  "HV", "MDD", "UNSURE", "Total", NA, "HV", "MDD", "UNSURE", "Total", NA, "HV", "MDD", "UNSURE", "Total", NA, 
  "HV", "MDD", "UNSURE", "Total", NA, "HV", "MDD", "UNSURE", "Total", NA), 
  Eligible=c("0","0","0","0","0", "1","1","1","1","1", "2","2","2","2","2", "3","3","3","3","3", "4","4","4","4","4", 
    "5","5","5","5","5", "6","6","6","6","6", "7","7","7","7","7", "Total","Total","Total","Total","Total", 
    NA,NA,NA,NA,NA), Freq=c("0")) %>% mutate(Eligible=as.character(Eligible), Freq=as.numeric(Freq))
######## Real table
screens <- master_IRTA_screens_latest %>% filter(!is.na(Screening_Start_Date))
screens_table1 <- ctable(screens$Participant_Type2, screens$Eligible, 
                  useNA = "always", prop="r", totals=FALSE, display.type=FALSE) %>% as.data.frame() %>% 
  rename(Freq = "cross_table.Freq") %>% rename(Participant_Type2 = "cross_table.screens.Participant_Type2") %>% 
  rename(Eligible = "cross_table.screens.Eligible") %>% select(-matches("proportions"))
screens_table1 <- na_if(screens_table1, "<NA>")

######## Combined table
screens_table1 <- merge.default(screens_table1, screens_dummy, all=TRUE) %>%
 group_by(Participant_Type2, Eligible) %>% arrange(desc(Freq)) %>% slice(1) %>% ungroup() %>% mutate(Eligible=as.character(Eligible))
screens_table1$Eligible <- replace_na(screens_table1$Eligible, "Missing")

######## Table to print
screens_table2 <- pivot_wider(screens_table1, id_cols = "Eligible", names_from = "Participant_Type2", values_from = "Freq") %>% 
  arrange(Eligible)
screens_table2$Eligible <- recode(screens_table2$Eligible, "0"="Include: fully eligible", "1"="Include: can't scan (braces, etc.)",
  "2"="On hold: contact again after specified amount of time", "3"="On hold: low priority", 
  "4"="Excluded: cannot be reached or scheduled, all contact options exhausted", "5"="Excluded: does not meet criteria", 
  "6"="Excluded: meets exclusionary criteria (substance use, psychosis, etc.)",
  "7"="Patient (or parent) withdrew", .missing = NULL)
screens_table2[,2:ncol(screens_table2)] <- lapply(screens_table2[,2:ncol(screens_table2)], replace_na, "0")
screens_table2[,2:ncol(screens_table2)] <- lapply(screens_table2[,2:ncol(screens_table2)], as.numeric)

# screens_table2 <- screens_table2 %>% mutate(Unsuccessful_Percent = ((Unsuccessful/Total) * 100)) %>% mutate(Unsuccessful_Percent = round(Unsuccessful_Percent, 2)) %>% 
#   mutate(Successful_Percent = ((Successful/Total) * 100)) %>% mutate(Successful_Percent = round(Successful_Percent, 2)) %>% 
#   mutate(Missing_Percent = ((Missing/Total) * 100)) %>% mutate(Missing_Percent = round(Missing_Percent, 2)) %>% 
#   select(Participant_Type2, Successful, Successful_Percent, Unsuccessful, Unsuccessful_Percent, Missing, Missing_Percent, Total)
# screens_table2[,2:ncol(screens_table2)] <- lapply(screens_table2[,2:ncol(screens_table2)], replace_na, "0")
# screens_table2$Participant_Type2 <- gsub("Total", "TOTAL", screens_table2$Participant_Type2)

######## Variables to remove
rm(screens_dummy, screens_table1)

```

```{r echo=FALSE, message=FALSE, warning=FALSE}

# screens_table2 %>% kable(., col.names = c("Diagnosis", "Contact Successful", "%", "Contact Unsuccessful", "%", 
#                                           "Contact not recorded", "%", "Total")) %>% 
#   kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

screens_table2=as.data.frame(cbind(screens_table2[,-4],screens_table2[,4]))
screens_table2 %>% kable(., col.names = c("Eligibility", "HV", "MDD",  "UNSURE", "NA","Total")) %>% 
  kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

```

Status Of those currently screening:

```{r echo=FALSE, warning=FALSE, message=FALSE, results="hide" }

screens_current <- screens %>% filter(Screening_initial_contact_successful==1)

screens_dummy_table <- tibble(Participant_Type2=c(NA), Parent_e_consented_freq.0=c(NA), Parent_e_consented_freq.1=c(NA), 
                                Child_e_assent_freq.0=c(NA), Child_e_assent_freq.1=c(NA), Parent_DAWBA_completed_freq.0=c(NA), Parent_DAWBA_completed_freq.1=c(NA), 
                                Child_DAWBA_completed_freq.0=c(NA), Child_DAWBA_completed_freq.1=c(NA)) %>% as.data.frame()

screens_current_table1 <- table(screens_current$Participant_Type2, screens_current$Child_e_assented) %>% as.data.frame() %>% 
  rename(Child_e_assented = "Var2", Child_e_assent_freq = "Freq", Participant_Type2 = "Var1") %>%
  reshape(., idvar = "Participant_Type2", timevar = "Child_e_assented", direction = "wide") 
screens_current_table2 <- table(screens_current$Participant_Type2, screens_current$Parent_e_consented) %>% as.data.frame() %>% 
  rename(Parent_e_consented = "Var2", Parent_e_consented_freq = "Freq", Participant_Type2 = "Var1") %>%
  reshape(., idvar = "Participant_Type2", timevar = "Parent_e_consented", direction = "wide") 
screens_current_table3 <- table(screens_current$Participant_Type2, screens_current$Child_DAWBA_completed) %>% as.data.frame() %>% 
  rename(Child_DAWBA_completed = "Var2", Child_DAWBA_completed_freq = "Freq", Participant_Type2 = "Var1") %>%
  reshape(., idvar = "Participant_Type2", timevar = "Child_DAWBA_completed", direction = "wide") 
screens_current_table4 <- table(screens_current$Participant_Type2, screens_current$Parent_DAWBA_completed) %>% as.data.frame() %>% 
  rename(Parent_DAWBA_completed = "Var2", Parent_DAWBA_completed_freq = "Freq", Participant_Type2 = "Var1") %>%
  reshape(., idvar = "Participant_Type2", timevar = "Parent_DAWBA_completed", direction = "wide") 

screens_current_table <- merge.default(screens_current_table2, screens_current_table1, all=TRUE) %>%
  merge.default(., screens_current_table4, all=TRUE) %>% merge.default(., screens_current_table3, all=TRUE) %>%
  merge.default(., screens_dummy_table, all=TRUE) %>% filter(!is.na(Participant_Type2)) %>% 
  reshape(., varying = c("Parent_e_consented_freq.0", "Parent_e_consented_freq.1", "Child_e_assent_freq.0", "Child_e_assent_freq.1",
                         "Parent_DAWBA_completed_freq.0", "Parent_DAWBA_completed_freq.1", "Child_DAWBA_completed_freq.0",
                         "Child_DAWBA_completed_freq.1"), direction = "long", idvar = "Participant_Type2", new.row.names=c(1:6))
screens_current_table[,3:6] <- lapply(screens_current_table[,3:6], replace_na, 0)

rm(screens, screens_current, screens_current_table1, screens_current_table2, screens_current_table3, screens_current_table4)

```

```{r echo=FALSE, warning=FALSE, message=FALSE}

screens_current_table %>% arrange(Participant_Type2) %>% filter(time==1 & Participant_Type2 != "UNSURE") %>% select(-time) %>% 
  kable(., col.names = c("Diagnosis", "Parent e-consented", "Child e-assented", "Parent DAWBA complete", 
                         "Child DAWBA complete")) %>% 
  kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

```

***

##### Current screens already in our screening database:

Check `r paste0(IRTA_tracker_location,"QCing/Screens_already_in_DB_", todays_date_formatted, ".xlsx")` for full details of duplicate participants. 

```{r echo=FALSE, warning=FALSE, message=FALSE, results="hide" }

suppressWarnings(source(paste0(scripts, 'Other_functions/check_referrals.R'),local=TRUE))

```

```{r echo=FALSE, warning=FALSE, message=FALSE}

if (nrow(all_repeats)=="0") {
  all_repeats <- rbind(all_repeats, tibble(Initials=c("No current screens found in old screening database"), 
    IRTA_tracker=c(NA), IRTA_screen=c(NA)))
  }

all_repeats %>% select(Initials, IRTA_tracker, IRTA_screen) %>% 
  kable(., col.names = c("Initials", "Appeared in", "Also currently screening by")) %>% 
  kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

```

***

##### Ready to review at clinical meeting (i.e. both parent and child have completed the DAWBA): 

```{r echo=FALSE, warning=FALSE, message=FALSE, results="hide" }

ready_2_review <- master_IRTA_screens_latest %>% 
  mutate(DAWBA_ready = (as.numeric(Parent_DAWBA_completed) + as.numeric(Child_DAWBA_completed))) %>% 
  filter(DAWBA_ready==2) %>% 
  select(Initials, Participant_Type2, DAWBA_ID)

```

```{r echo=FALSE, warning=FALSE, message=FALSE}

if (nrow(ready_2_review)=="0") {
  ready_2_review <- rbind(ready_2_review, tibble(Initials=c("No participants ready to review"), Participant_Type2=c(NA), DAWBA_ID=c(NA)))
  }

ready_2_review %>% kable(., col.names = c("Initials", "Participant Type", "DAWBA ID")) %>% 
  kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

```

***

##### New evaluation visits: 

Scheduling:

```{r echo=FALSE, warning=FALSE, message=FALSE, results="hide" }

######## Dummy table
scheduling_dummy <- tibble(Participant_Type2=c("HV", "MDD", "HV", "MDD", "HV", "MDD", "HV", "MDD", "Total", NA, "Total", NA, "Total", NA, "Total", NA), 
  Eligible=c("0", "0", "1", "1", "2", "2", "3", "3", "0", "0", "1", "1", "2", "2", "3", "3"), Freq=c("0")) %>% 
  mutate(Eligible=as.character(Eligible), Freq=as.numeric(Freq))

######## Real table
scheduling <- master_IRTA_latest %>% filter(IRTA_tracker!="REMOVED") %>% 
  select(Initials, SDAN, IRTA_tracker, Participant_Type2, Eligible, Clinical_Visit_Type, Clinical_Visit_Date, Scheduling_status, 
         Protocol) %>% group_by(Initials) %>% slice(1) %>% ungroup() %>% filter(is.na(Clinical_Visit_Date)) %>%
  mutate(Eligible = as.numeric(Eligible)) %>% filter(Eligible<4 | is.na(Eligible))
scheduling_table <- ctable(scheduling$Participant_Type2, scheduling$Eligible, 
                  useNA = "always", prop="r", totals=FALSE, display.type=FALSE) %>% as.data.frame() %>% 
  rename(Freq = "cross_table.Freq") %>% rename(Participant_Type2 = "cross_table.scheduling.Participant_Type2") %>% 
  rename(Eligible = "cross_table.scheduling.Eligible") %>% select(Participant_Type2, Eligible, Freq) %>%
  mutate(Eligible=as.character(Eligible)) %>% mutate(Participant_Type2=as.character(Participant_Type2))
scheduling_table <- na_if(scheduling_table, "<NA>")

######## Combined table
scheduling_table <- merge.default(scheduling_table, scheduling_dummy, all=TRUE) %>% arrange(Eligible) %>% 
 group_by(Participant_Type2, Eligible) %>% arrange(desc(Freq)) %>% slice(1) %>% ungroup()
scheduling_table$Participant_Type2 <- replace_na(scheduling_table$Participant_Type2, "Missing")

######## Table to print
scheduling_table2 <- pivot_wider(scheduling_table, id_cols = "Eligible", names_from = "Participant_Type2", values_from = "Freq") 
scheduling_table2[,2:ncol(scheduling_table2)] <- lapply(scheduling_table2[,2:ncol(scheduling_table2)], replace_na, "0")
scheduling_table2[,2:ncol(scheduling_table2)] <- lapply(scheduling_table2[,2:ncol(scheduling_table2)], as.numeric)
scheduling_table2 <- scheduling_table2 %>% mutate(HV_Percent = ((HV/Total) * 100)) %>% mutate(HV_Percent = round(HV_Percent, 2)) %>% 
  mutate(MDD_Percent = ((MDD/Total) * 100)) %>% mutate(MDD_Percent = round(MDD_Percent, 2)) %>% 
  mutate(Missing_Percent = ((Missing/Total) * 100)) %>% mutate(Missing_Percent = round(Missing_Percent, 2)) %>% 
  select(Eligible, MDD, MDD_Percent, HV, HV_Percent, Missing, Missing_Percent, Total)
scheduling_table2[,2:ncol(scheduling_table2)] <- lapply(scheduling_table2[,2:ncol(scheduling_table2)], replace_na, "0")

scheduling_table2$Eligible <- recode(scheduling_table2$Eligible, "0"="Include: fully eligible", "1"="Include: can't scan (braces, etc.)", 
  "2"="On hold: contact again after specified amount of time", "3"="On hold: low priority", .missing = NULL)

######## Variables to remove
rm(scheduling, scheduling_table)

```

```{r echo=FALSE, warning=FALSE, message=FALSE}

scheduling_table2 %>% kable(., col.names = c("Status", "MDD", "%", "HV", "%", "Unknown", "%", "Total")) %>% 
  kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

```

Scheduled: 

```{r echo=FALSE, warning=FALSE, message=FALSE, results="hide" }

scheduled_JM <- master_IRTA_screens_latest %>% filter(IRTA_tracker=="JM") %>% select(Initials, SDAN, IRTA_tracker, Participant_Type2, 
  Eligible, Clinical_Visit_Type, Clinical_Visit_Date, Scheduling_status, Protocol) %>% 
  filter(Clinical_Visit_Date>todays_date_formatted)
scheduled_other <- master_IRTA_latest %>% filter(IRTA_tracker!="REMOVED") %>% 
  select(Initials, SDAN, IRTA_tracker, Participant_Type2, Eligible, Clinical_Visit_Type, Clinical_Visit_Date, Scheduling_status, 
         Protocol) %>% group_by(Initials) %>% arrange(Clinical_Visit_Date) %>% slice(1) %>% ungroup() %>% 
  filter(Clinical_Visit_Date>todays_date_formatted)

scheduled <- merge.default(scheduled_other, scheduled_JM, all = TRUE)

```

```{r echo=FALSE, warning=FALSE, message=FALSE}

if (nrow(scheduled)=="0") {
  scheduled <- rbind(scheduled, tibble(Initials=c("No participants scheduled"), Participant_Type2=c(NA), Clinical_Visit_Date=c(NA)))
  }

scheduled %>% arrange(Clinical_Visit_Date) %>% select(Initials, Participant_Type2, Clinical_Visit_Date) %>% 
  kable(., col.names = c("Initials", "Diagnosis", "Visit Date")) %>% 
  kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

```

***

##### Enrolled in 0037:

```{r echo=FALSE, warning=FALSE, message=FALSE, results="hide" }

# Changed 0037 to 0039 to see if I could break chunk and if it would still run correctly (changed back after successful check) - LE practice

protocol_0037 <- master_IRTA_latest %>% filter(str_detect(Protocol, "0037")) %>% group_by(Initials) %>% 
  slice(n()) %>% ungroup() %>% select(Initials, IRTA_tracker, Participant_Type2, Eligible, Eligibility_notes, Clinical_Visit_Type,
                                    Clinical_Visit_Date, Consent_Date, Protocol) 


# Create dummy variables to check if code is running correctly and how to run the next few code chunks - LE practice 

if (nrow(protocol_0037)=="0"){
  do_next_chunk <- FALSE
  do_next_chunk_2 <-TRUE
} else {
  do_next_chunk <- TRUE
  do_next_chunk_2 <- FALSE
}

```

```{r echo=FALSE, warning=FALSE, message=FALSE, results="hide", eval=do_next_chunk}

protocol_0037$Protocol_Type[str_detect(protocol_0037$Protocol, 'SCREENING')] <- 'Screening'
protocol_0037$Protocol_Type[str_detect(protocol_0037$Protocol, 'Screening')] <- 'Screening'
protocol_0037$Protocol_Type[is.na(protocol_0037$Protocol_Type)] <- 'Characterization'

protocol_table <- ctable(protocol_0037$Participant_Type2, protocol_0037$Protocol_Type, 
                  useNA = "always", prop="r", totals=FALSE, display.type=FALSE) %>% 
  as.data.frame() %>% rename(Freq = "cross_table.Freq") %>% rename(Participant_Type2 = "cross_table.protocol_0037.Participant_Type2") %>% 
  rename(Protocol = "cross_table.protocol_0037.Protocol_Type") %>% 
  select(-proportions.Total)

protocol_table2 <- reshape(protocol_table, idvar = "Participant_Type2", timevar = "Protocol", direction = "wide") %>% 
  mutate(Characterization_Percent = (proportions.Characterization.Characterization * 100)) %>% 
  mutate(Characterization_Percent = round(Characterization_Percent, 2)) %>%
  mutate(Screening_Percent = (proportions.Screening.Screening * 100)) %>% 
  mutate(Screening_Percent = round(Screening_Percent, 2)) %>%
  select(Participant_Type2, Freq.Characterization, Characterization_Percent, Freq.Screening, Screening_Percent, Freq.Total)
protocol_table2 <- na_if(protocol_table2,  "<NA>")

######## Current eligibility of all enrolled 

protocol_0037_characterization <- protocol_0037 %>% filter(Protocol_Type=="Characterization") 
protocol_0037_characterization_table <- ctable(protocol_0037_characterization$Eligible, protocol_0037_characterization$Participant_Type2, 
                  useNA = "always", prop="r", totals=FALSE, display.type=FALSE) %>% 
  as.data.frame() %>% rename(Freq = "cross_table.Freq") %>% rename(Participant_Type2 = "cross_table.protocol_0037_characterization.Participant_Type2") %>% 
  rename(Eligible = "cross_table.protocol_0037_characterization.Eligible") %>% 
  select(-matches("proportions")) 
protocol_0037_characterization_table2 <- reshape(protocol_0037_characterization_table, idvar = "Eligible", timevar = "Participant_Type2", direction = "wide") %>% 
  mutate_all(as.character)
protocol_0037_characterization_table2 <- na_if(protocol_0037_characterization_table2,  "<NA>")
order <- tibble(Order=c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14), Eligible=c("0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", NA, "Total"))
protocol_0037_characterization_table3 <- left_join(protocol_0037_characterization_table2, order) %>% arrange(Order) %>% select(-Order) %>% mutate_all(as.character)

protocol_0037_characterization_table3$Eligible <- recode(protocol_0037_characterization_table3$Eligible,
  "0"="Include", 
  "1"="Include: canâ€™t scan (braces, etc.)", 
  "2"="On hold: contact again after specified amount of time", 
  "3"="On hold: low priority", 
  "4"="Excluded: cannot be reached or scheduled, all contact options exhausted",
  "5"="Excluded: does not meet criteria", 
  "6"="Excluded: meets exclusionary criteria (substance use, psychosis, etc.)", 
  "7"="Withdrawn: did not or withdrew assent/consent",
  "8"="Treatment status 1: ruled as ineligible for treatment during baseline assessment",
  "9"="Treatment status 2: patient (or parent) withdrew from treatment",
  "10"="Treatment status 3: excluded after commencing treatment: clinician decision",
  "11"="Treatment status 4: completed treatment",
  "Total"="Total", .missing = NULL)

tot_withdrew <- protocol_0037_characterization %>% filter(Eligible == 4 | Eligible == 5 | Eligible == 6 | 
    Eligible == 7  | Eligible == 9  | Eligible == 10) %>% nrow()

rm(protocol_0037, protocol_table, protocol_0037_characterization, protocol_0037_characterization_table, protocol_0037_characterization_table2)
    
```

All eval visits:

```{r echo=FALSE, warning=FALSE, message=FALSE, eval=do_next_chunk}

protocol_table2 %>% kable(., col.names = c("Diagnosis", "Signed into Characterization", "%", 
                                           "Signed Screening Consents Only", "%", "Total")) %>% 
  kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

```

```{r echo=FALSE, warning=FALSE, message=FALSE, eval=do_next_chunk_2}

# practice chunk to see if I can sucessfully break code and run it without problems - LE practice

print('Something went wrong - no protocols found')
tot_withdrew <- "Not Calculated"

```

Current status of everyone who signed full characterization consents: 

```{r echo=FALSE, warning=FALSE, message=FALSE, eval=do_next_chunk}

protocol_0037_characterization_table3 %>% kable(., col.names = c("Eligible", "Anxious", "HV", "MDD", "Dx Missing", "Total")) %>% 
  kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

```

Resulting in **`r tot_withdrew`** excluded/withdrawn in total.

*** 

##### Longitudinal clinical follow up

```{r echo=FALSE, warning=FALSE, message=FALSE, results="hide" }

baseline <- Psychometrics_treatment %>% 
  select(Initials, IRTA_tracker, Participant_Type2, Protocol, Clinical_Visit_Date, Clinical_Visit_Type, c_ksadsdx_visit_type, c_ksadsdx_date) %>% 
  filter(!is.na(c_ksadsdx_visit_type) & c_ksadsdx_visit_type != "Inpatient Treatment" & c_ksadsdx_visit_type != "Outpatient Treatment")
baseline$Clinical_Visit_Date <- as.Date(baseline$Clinical_Visit_Date)
baseline$c_ksadsdx_date <- as.Date(baseline$c_ksadsdx_date)
baseline$c_ksadsdx_TDiff <- as.numeric(difftime(baseline$Clinical_Visit_Date, baseline$c_ksadsdx_date, tz="", units = "days"))
baseline <- baseline %>% mutate(measurement_TDiff_abs=abs(c_ksadsdx_TDiff)) %>% 
  group_by(Initials, c_ksadsdx_visit_type) %>% arrange(Initials, c_ksadsdx_visit_type, measurement_TDiff_abs) %>% 
  slice(1) %>% ungroup() %>% select(-measurement_TDiff_abs) %>% arrange(Initials, Clinical_Visit_Date)

#### excluding removed participants
latest_eligibility <- Psychometrics_treatment %>% select(Initials, Eligible, IRTA_tracker, Clinical_Visit_Type, Clinical_Visit_Date, Protocol) %>% 
  group_by(Initials) %>% arrange(Initials, Clinical_Visit_Date) %>% slice(n()) %>% ungroup() %>% mutate(Eligible = as.numeric(Eligible))
# missing_diag <- merge.default(baseline, latest_eligibility, all = TRUE) %>% group_by(Initials) %>% fill(IRTA_tracker:Eligible, .direction = "up") %>% 
#   fill(IRTA_tracker:Eligible, .direction = "down") %>% slice(1) %>% ungroup() %>% filter(is.na(c_ksadsdx_date))
# missing_diag %>% write_xlsx(paste0(IRTA_tracker_location, "QCing/Missing_diagnosis.xlsx"))
baseline <- latest_eligibility %>% select(Initials, Eligible) %>% left_join(baseline, .)
latest_eligibility <- latest_eligibility %>% mutate(remove1 = ifelse((Eligible > 3 & Eligible < 11), 1, 0))
latest_eligibility <- latest_eligibility %>% mutate(remove2 = ifelse((IRTA_tracker == "REMOVED"), 1, 0))
latest_eligibility <- latest_eligibility %>% mutate(remove3 = ifelse((!str_detect(Protocol, "0037") | str_detect(Protocol, "SCREENING")), 1, 0))
latest_eligibility[,7:9] <- lapply(latest_eligibility[7:9], replace_na, 0)
latest_eligibility <- latest_eligibility %>% mutate(remove=(remove1 + remove2 + remove3)) %>% filter(remove>0)
removed_initials <- latest_eligibility$Initials
baseline$exclude <- (baseline$Initials %in% removed_initials) %>% as.character()

#### incorporating scanner information 
scanner <- master_IRTA_latest %>% filter(!is.na(Scanner)) %>% group_by(Initials) %>% arrange(Initials, Clinical_Visit_Date) %>% slice(n()) %>% ungroup() %>% select(Initials, Scanner)
baseline <- left_join(baseline, scanner)

#### completed annual FU visit 
FU_completed <- baseline %>% group_by(Initials) %>% filter(n()>1) %>% ungroup() %>% 
  select(-c_ksadsdx_TDiff, -exclude, -Protocol, -Clinical_Visit_Type) %>% filter(c_ksadsdx_visit_type!="baseline")
MDD_one_year <- FU_completed %>% filter(c_ksadsdx_visit_type=="12 month FU") %>% filter(Participant_Type2=="MDD") %>% nrow() %>% as.numeric()
MDD_two_year <- FU_completed %>% filter(c_ksadsdx_visit_type=="24 month FU") %>% filter(Participant_Type2=="MDD") %>% nrow() %>% as.numeric()
MDD_three_year <- FU_completed %>% filter(c_ksadsdx_visit_type=="36 month FU") %>% filter(Participant_Type2=="MDD") %>% nrow() %>% as.numeric()
HV_one_year <- FU_completed %>% filter(c_ksadsdx_visit_type=="12 month FU") %>% filter(Participant_Type2=="HV") %>% nrow() %>% as.numeric()
HV_two_year <- FU_completed %>% filter(c_ksadsdx_visit_type=="24 month FU") %>% filter(Participant_Type2=="HV") %>% nrow() %>% as.numeric()
HV_three_year <- FU_completed %>% filter(c_ksadsdx_visit_type=="36 month FU") %>% filter(Participant_Type2=="HV") %>% nrow() %>% as.numeric()

# Create table based on annual visits calculated above
FU_completed_summary <- tibble(Type=c("12 month", "12 month", "24 month", "24 month","36 month", "36 month"), Diagnosis=c("MDD", "HV", "MDD", "HV","MDD","HV"), 
                               Freq=c(MDD_one_year, HV_one_year, MDD_two_year, HV_two_year, MDD_three_year, HV_three_year))

#### eligible for annual FU - not yet completed 
baseline_keep <- baseline %>% filter(exclude=="FALSE") %>% group_by(Initials) %>% filter(n()==1) %>% ungroup() %>% 
  select(-c_ksadsdx_TDiff, -exclude, -Protocol, -Clinical_Visit_Type)

baseline_keep <- baseline_keep %>% mutate(expt_FU_date = (c_ksadsdx_date + 365))
baseline_keep$expt_FU_date_TDiff <- as.numeric(difftime(baseline_keep$expt_FU_date, todays_date_formatted, tz="", units = "days"))

baseline_keep <- baseline_keep %>% mutate(status = 
    ifelse((expt_FU_date_TDiff < -30), 1, # more than one month overdue 
    ifelse((expt_FU_date_TDiff >= -30 & expt_FU_date_TDiff < 0), 2, # less than one month overdue
    ifelse((expt_FU_date_TDiff >= 0 & expt_FU_date_TDiff < 31), 3, # due within the next month
    ifelse((expt_FU_date_TDiff >= 31 & expt_FU_date_TDiff < 191), 4, # due in >1 month but <6 months
    ifelse((expt_FU_date_TDiff >= 191 & expt_FU_date_TDiff < 275), 5, # due in >6 months but <9 months
    ifelse((expt_FU_date_TDiff >= 275), 6, #due in >9 months
           0)))))))

#check for 2nd year follow up
#they've had baseline and annual follow up
y1_keep <- baseline %>% filter(exclude=="FALSE") %>% group_by(Initials) %>% filter(n()==2) %>% slice(1) %>% ungroup() %>% 
  select(-c_ksadsdx_TDiff, -exclude, -Protocol, -Clinical_Visit_Type) 

y1_keep <- y1_keep %>% mutate(expt_FU_date = (c_ksadsdx_date + (2*365)))
y1_keep$expt_FU_date_TDiff <- as.numeric(difftime(y1_keep$expt_FU_date, todays_date_formatted, tz="", units = "days"))

y1_keep <- y1_keep %>% mutate(status = 
    ifelse((expt_FU_date_TDiff < -30), 1, # more than one month overdue 
    ifelse((expt_FU_date_TDiff >= -30 & expt_FU_date_TDiff < 0), 2, # less than one month overdue
    ifelse((expt_FU_date_TDiff >= 0 & expt_FU_date_TDiff < 31), 3, # due within the next month
    ifelse((expt_FU_date_TDiff >= 31 & expt_FU_date_TDiff < 191), 4, # due in >1 month but <6 months
    ifelse((expt_FU_date_TDiff >= 191 & expt_FU_date_TDiff < 275), 5, # due in >6 months but <9 months
    ifelse((expt_FU_date_TDiff >= 275), 6, #due in >9 months
           0)))))))

#check for 2nd year follow up
#they've had baseline and annual follow up
y2_keep <- baseline %>% filter(exclude=="FALSE") %>% group_by(Initials) %>% filter(n()==3) %>% slice(1) %>% ungroup() %>% 
  select(-c_ksadsdx_TDiff, -exclude, -Protocol, -Clinical_Visit_Type) 

y2_keep <- y2_keep %>% mutate(expt_FU_date = (c_ksadsdx_date + (3*365)))
y2_keep$expt_FU_date_TDiff <- as.numeric(difftime(y2_keep$expt_FU_date, todays_date_formatted, tz="", units = "days"))

y2_keep <- y2_keep %>% mutate(status = 
    ifelse((expt_FU_date_TDiff < -30), 1, # more than one month overdue 
    ifelse((expt_FU_date_TDiff >= -30 & expt_FU_date_TDiff < 0), 2, # less than one month overdue
    ifelse((expt_FU_date_TDiff >= 0 & expt_FU_date_TDiff < 31), 3, # due within the next month
    ifelse((expt_FU_date_TDiff >= 31 & expt_FU_date_TDiff < 191), 4, # due in >1 month but <6 months
    ifelse((expt_FU_date_TDiff >= 191 & expt_FU_date_TDiff < 275), 5, # due in >6 months but <9 months
    ifelse((expt_FU_date_TDiff >= 275), 6, #due in >9 months
           0)))))))

#check for 3rd year follow up
#they've had baseline and annual follow up
y3_keep <- baseline %>% filter(exclude=="FALSE") %>% group_by(Initials) %>% filter(n()==4) %>% slice(1) %>% ungroup() %>% 
  select(-c_ksadsdx_TDiff, -exclude, -Protocol, -Clinical_Visit_Type) 

y3_keep <- y3_keep %>% mutate(expt_FU_date = (c_ksadsdx_date + (4*365)))
y3_keep$expt_FU_date_TDiff <- as.numeric(difftime(y3_keep$expt_FU_date, todays_date_formatted, tz="", units = "days"))

y3_keep <- y3_keep %>% mutate(status = 
    ifelse((expt_FU_date_TDiff < -30), 1, # more than one month overdue 
    ifelse((expt_FU_date_TDiff >= -30 & expt_FU_date_TDiff < 0), 2, # less than one month overdue
    ifelse((expt_FU_date_TDiff >= 0 & expt_FU_date_TDiff < 31), 3, # due within the next month
    ifelse((expt_FU_date_TDiff >= 31 & expt_FU_date_TDiff < 191), 4, # due in >1 month but <6 months
    ifelse((expt_FU_date_TDiff >= 191 & expt_FU_date_TDiff < 275), 5, # due in >6 months but <9 months
    ifelse((expt_FU_date_TDiff >= 275), 6, #due in >9 months
           0)))))))

#probably need to change the code to include other follow ups too, if we decide to do it all seperate
all_keep=bind_rows(baseline_keep, y1_keep, y2_keep, y3_keep)
##############


temp1 <- ctable(baseline_keep$status, baseline_keep$Participant_Type2, useNA = "no",
                           prop="r", totals=FALSE, display.type=FALSE) %>% as.data.frame() %>% 
  rename(Freq = "cross_table.Freq") %>% rename(Participant_Type2 = "cross_table.baseline_keep.Participant_Type2") %>%
  rename(Status = "cross_table.baseline_keep.status") %>% select(-proportions.Total)

temp2 <- pivot_wider(temp1, id_cols = "Status", names_from = "Participant_Type2", values_from = "Freq") %>% 
  mutate(HV_percent = (HV/(HV+MDD)*100)) %>% mutate(MDD_percent = (MDD/(HV+MDD)*100)) %>% 
  mutate(HV_percent = round(HV_percent, 2), MDD_percent = round(MDD_percent, 2))
MDD_6_months <- temp2 %>% filter(Status == "2" | Status == "3" | Status == "4") %>% select(MDD) %>% colSums() %>% as.numeric()
HV_6_months <- temp2 %>% filter(Status == "2" | Status == "3" | Status == "4") %>% select(HV) %>% colSums() %>% as.numeric()

rest_temp <- tibble(Status=c(1, 2, 3, 4, 5, 6), Descrip=c("more than one month overdue", "less than one month overdue", "due <1 month, i.e. by:", 
      "due >1 month & <6 months, i.e. by:", "due >6 months & <9 months, i.e. by:", "due >9 months by:"))
date_temp <- c((todays_date_formatted + 30), (todays_date_formatted + 190), (todays_date_formatted + 274), (todays_date_formatted + 365)) %>% 
  as_tibble() %>% rename(Date = value) %>% mutate(Status=c(3, 4, 5, 6))
descrip_table <- merge.default(rest_temp, date_temp, all=TRUE)

temp3 <- merge.default(temp2, descrip_table, all=TRUE) %>%
  select(Descrip, Date, MDD, MDD_percent, HV, HV_percent, Total)
temp3$Descrip <- replace_na(temp3$Descrip, "Total")

overdue <- baseline_keep %>% filter(status==1) %>% select(Initials, IRTA_tracker, Participant_Type2, Eligible, expt_FU_date_TDiff) %>% filter(Initials!="ANHY")
overdue$Eligible <- recode(overdue$Eligible, "0"="Include: fully eligible", "1"="Include: can't scan (braces, etc.)", 
  "2"="On hold: contact again after specified amount of time", "3"="On hold: low priority", "11"="Completed treatment", .missing = NULL)

temp1a_scanner <- ctable(baseline_keep$status, baseline_keep$Scanner, useNA = "no",
                           prop="r", totals=FALSE, display.type=FALSE) %>% as.data.frame() %>% 
  rename(Freq = "cross_table.Freq") %>% rename(Scanner = "cross_table.baseline_keep.Scanner") %>%
  rename(Status = "cross_table.baseline_keep.status") %>% select(-proportions.Total)
six_months_3TA <- temp1a_scanner %>% filter(Status == "2" | Status == "3" | Status == "4") %>% filter(Scanner=="3TA") %>% select(Freq) %>% colSums() %>% as.numeric()
six_months_3TC <- temp1a_scanner %>% filter(Status == "2" | Status == "3" | Status == "4") %>% filter(Scanner=="3TC") %>% select(Freq) %>% colSums() %>% as.numeric()

#rm(baseline, baseline_removed, removed_initials, FU_completed, all_keep, temp1, temp2, rest_temp, date_temp, descrip_table, 
#MDD_one_year, MDD_two_year, HV_one_year, HV_two_year, temp1a_scanner)


```

Completed annual follow up

```{r echo=FALSE, warning=FALSE, message=FALSE}

FU_completed_summary %>% kable(., col.names = c("Follow up type", "Diagnosis", "Number completed")) %>%
  kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

```

<!-- commented this since added a table with all the annual follow ups -->
<!-- Completed baseline, eligible for annual follow up -->

<!-- ```{r echo=FALSE, warning=FALSE, message=FALSE} -->

<!-- temp3 %>% kable(., col.names = c("Status", "", "MDD", "%", "HV", "%", "Total")) %>% -->
<!--   kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed")) -->

<!-- ``` -->

<!-- Summary:  -->

<!-- * MDDs due in next 6 months: `r MDD_6_months` -->
<!-- * HVs due in next 6 months: `r HV_6_months` -->
<!-- * Due on 3TA in next 6 months: `r six_months_3TA` -->
<!-- * Due on 3TC in next 6 months: `r six_months_3TC` -->

<!-- Participants long overdue for clinical follow up -->

<!-- ```{r echo=FALSE, warning=FALSE, message=FALSE} -->

<!-- if (nrow(overdue)=="0") { -->
<!--   overdue <- rbind(overdue, tibble(Initials=c("No participants more than one month overdue"), IRTA=c(NA), Diagnosis=c(NA), Eligibility=c(NA), expt_FU_date_TDiff=c(NA))) -->
<!--   } -->

<!-- overdue %>% arrange(expt_FU_date_TDiff) %>% kable(., col.names = c("Initials", "IRTA", "Diagnosis", "Eligibility", "Days overdue")) %>% -->
<!--   kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed")) -->

<!-- ``` -->


```{r echo=FALSE, warning=FALSE, message=FALSE, results="hide" }
for (i in 0:5){
  if(i==0){
    yr_keep=baseline_keep
    print(yr_keep)
  }
  else if(i==1){
    yr_keep=y1_keep
    print(yr_keep)
  }else if (i==2){
    yr_keep=y2_keep
  }else if (i==3){
    yr_keep=y3_keep
  }else{
    yr_keep=all_keep
  }
  
temp1 <- ctable(yr_keep$status, yr_keep$Participant_Type2, useNA = "no",
                prop="r", totals=FALSE, display.type=FALSE) %>% as.data.frame() %>% 
  rename(Freq = "cross_table.Freq") %>% rename(Participant_Type2 = "cross_table.yr_keep.Participant_Type2") %>%
  rename(Status = "cross_table.yr_keep.status") %>% select(-proportions.Total)

temp2 <- pivot_wider(temp1, id_cols = "Status", names_from = "Participant_Type2", values_from = "Freq") %>% 
  mutate(HV_percent = (HV/(HV+MDD)*100)) %>% mutate(MDD_percent = (MDD/(HV+MDD)*100)) %>% 
  mutate(HV_percent = round(HV_percent, 2), MDD_percent = round(MDD_percent, 2))
MDD_6_months <- temp2 %>% filter(Status == "2" | Status == "3" | Status == "4") %>% select(MDD) %>% colSums() %>% as.numeric()
HV_6_months <- temp2 %>% filter(Status == "2" | Status == "3" | Status == "4") %>% select(HV) %>% colSums() %>% as.numeric()

rest_temp <- tibble(Status=c(1, 2, 3, 4, 5, 6), Descrip=c("more than one month overdue", "less than one month overdue", "due <1 month, i.e. by:", 
                                                          "due >1 month & <6 months, i.e. by:", "due >6 months & <9 months, i.e. by:", "due >9 months by:"))
date_temp <- c((todays_date_formatted + 30), (todays_date_formatted + 190), (todays_date_formatted + 274), (todays_date_formatted + 365)) %>% 
  as_tibble() %>% rename(Date = value) %>% mutate(Status=c(3, 4, 5, 6))
descrip_table <- merge.default(rest_temp, date_temp, all=TRUE)

temp3 <- merge.default(temp2, descrip_table, all=TRUE) %>%
  select(Descrip, Date, MDD, MDD_percent, HV, HV_percent, Total)
temp3$Descrip <- replace_na(temp3$Descrip, "Total")

if(i==0){
  baselinetemp3=temp3
}
else if(i==1){
  y1temp3=temp3
}else if (i==2){
  y2temp3=temp3
}else if (i==3){
  y3temp3=temp3
} else {
  alltemp3=temp3
}
}
```

<!-- Eligible for annual follow up (including 12, 24, 36, and 48 months follow ups) -->

<!-- ```{r echo=FALSE, warning=FALSE, message=FALSE} -->

<!-- temp3 %>% kable(., col.names = c("Status", "", "MDD", "%", "HV", "%", "Total")) %>% -->
<!--   kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed")) -->

<!-- ``` -->

<!-- Completed 24 months, due for 36 months follow up -->
<!-- ```{r echo=FALSE, warning=FALSE, message=FALSE} -->

<!-- y2temp3 %>% kable(., col.names = c("Status", "", "MDD", "%", "HV", "%", "Total")) %>% -->
<!--   kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed")) -->

<!-- ``` -->

<!-- Completed 36 months, due for 48 months follow up -->
<!-- ```{r echo=FALSE, warning=FALSE, message=FALSE} -->

<!-- y3temp3 %>% kable(., col.names = c("Status", "", "MDD", "%", "HV", "%", "Total")) %>% -->
<!--   kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed")) -->

<!-- ``` -->

```{r echo=FALSE, warning=FALSE, message=FALSE}
baselinefu=baselinetemp3 %>% arrange(Descrip)
names(baselinefu)[3:7]=paste0("baseline",names(baselinefu)[3:7])
y1fu=y1temp3 %>% arrange(Descrip)
names(y1fu)[3:7]=paste0("y1",names(y1fu)[3:7])
y2fu=y2temp3 %>% arrange(Descrip)
names(y2fu)[3:7]=paste0("y2",names(y2fu)[3:7])
y3fu=y3temp3 %>% arrange(Descrip)
names(y3fu)[3:7]=paste0("y3",names(y3fu)[3:7])

y123fu=add_column(baselinefu,y1fu) %>% add_column(.,y2fu) %>% add_column(., y3fu)
y123fu= y123fu %>% replace_na(list(baselineMDD=0,y1MDD = 0, y2MDD = 0,y3MDD = 0,baselineHV=0,y1HV = 0, y2HV = 0,y3HV = 0))
#totalMDDcol=y123fu%>% select(y1MDD,y2MDD,y3MDD) %>% colSums()
totalMDDrow=y123fu%>% select(baselineMDD,y1MDD,y2MDD,y3MDD) %>% rowSums()
#totalHVcol=y123fu%>% select(y1HV,y2HV,y3HV) %>% colSums()
totalHVrow=y123fu%>% select(baselineHV,y1HV,y2HV,y3HV) %>% rowSums()
totalall=totalMDDrow+totalHVrow
y123fu=add_column(y123fu,totalMDDrow)%>%add_column(., totalHVrow) %>% add_column(., totalall)
#y123fu=add_column(y123fu,totalMDDcol)%>%add_column(., totalHVcol)
y123fuDisplay<-y123fu %>% select("Descrip","Date","baselineMDD","y1MDD","y2MDD","y3MDD","baselineHV","y1HV","y2HV","y3HV","totalMDDrow","totalHVrow","totalall")


```
Eligible for annual follow up :
```{r echo=FALSE, warning=FALSE, message=FALSE}

#the names are based on completed that year, eligible for the next follow up
y123fuDisplay %>% arrange("Descrip") %>% kable(., col.names = c("Descrip","Date","12m MDD","24m MDD","36m MDD","48m MDD", "12m HV","24m HV","36m HV","48m HV", "total MDD ","total HV","total")) %>%
  kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

```
***

#### 2. Task Numbers 

***

##### MID scans: 

Cross-sectional 

```{r echo=FALSE, warning=FALSE, message=FALSE, results="hide" }

diag_mid_1 <- task_reshape_master_QC %>% filter(Task_Name=="MID_scan") %>% filter(Participant_Type2 =="MDD" | Participant_Type2 == "HV") %>%
  filter(Age_at_visit>11) %>% filter(!is.na(Task_Number) & Task_Number != "777" & Task_Number != "999") %>%
  filter(Task_Date < todays_date_formatted)

diag_mid_2_table <- ctable(diag_mid_1$Task_Number, diag_mid_1$Participant_Type2, useNA = "no",
                           prop="r", totals=FALSE, display.type=FALSE) %>%
  as.data.frame() %>% rename(Freq = "cross_table.Freq") %>%
  rename(Participant_Type2 = "cross_table.diag_mid_1.Participant_Type2") %>%
  rename(Task_Number = "cross_table.diag_mid_1.Task_Number") %>% select(-proportions.Total)

diag_mid_3_table <- reshape(diag_mid_2_table, idvar = "Task_Number", timevar = "Participant_Type2", direction = "wide") %>%
  mutate(HV_Percent = (proportions.HV.HV * 100)) %>% mutate(HV_Percent = round(HV_Percent, 2)) %>%
  mutate(MDD_Percent = (proportions.MDD.MDD * 100)) %>% mutate(MDD_Percent = round(MDD_Percent, 2)) %>%
  select(Task_Number, Freq.MDD, MDD_Percent, Freq.HV, HV_Percent, Freq.Total)

rm(diag_mid_1, diag_mid_2_table)

```

```{r echo=FALSE, warning=FALSE, message=FALSE}

diag_mid_3_table %>% kable(., col.names = c("Task Number", "MDD", "%", "HV", "%", "Total")) %>%
  kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

```

Longitudinal

```{r echo=FALSE, warning=FALSE, message=FALSE, results="hide" }

mid_long <- task_reshape_master_QC %>% filter(Task_Name=="MID_scan") %>% filter(str_detect(Task_Visit_Type, "v")) %>% 
  filter(Task_Number!="777" & Task_Number!="999") %>%
  select(Initials, Participant_Type2, Task_Date, Task_Number, Task_Visit_Type) 

```

```{r echo=FALSE, warning=FALSE, message=FALSE, results="hide" }

#### follow up numbers
fu_dates <- mid_long %>% filter(Task_Visit_Type=="v1") %>%
  mutate(month4 = (Task_Date + 120), month8 = (Task_Date + 240), month12 = (Task_Date + 360)) %>% mutate(source2="FU")
fu_dates$month4_past <- (todays_date_formatted >= fu_dates$month4) %>% as.character()
fu_dates$month8_past <- (todays_date_formatted >= fu_dates$month8) %>% as.character()
fu_dates$month12_past <- (todays_date_formatted >= fu_dates$month12) %>% as.character()

```

```{r echo=FALSE, warning=FALSE, message=FALSE, results="hide" }

#### calculating the demoninators
## MDD
denominator_mdd_v1 <- mid_long %>% filter(Participant_Type2=="MDD") %>% select(Task_Visit_Type) %>%
  filter(Task_Visit_Type=="v1") %>% nrow() %>% as.numeric()
denominator_mdd_v2 <- fu_dates %>% filter(Participant_Type2=="MDD") %>% select(month4_past) %>%
  filter(month4_past=="TRUE") %>% nrow() %>% as.numeric()
denominator_mdd_v3 <- fu_dates %>% filter(Participant_Type2=="MDD") %>% select(month8_past) %>%
  filter(month8_past=="TRUE") %>% nrow() %>% as.numeric()
denominator_mdd_v4 <- fu_dates %>% filter(Participant_Type2=="MDD") %>% select(month12_past) %>%
  filter(month12_past=="TRUE") %>% nrow() %>% as.numeric()
## HV
denominator_hv_v1 <- mid_long %>% filter(Participant_Type2=="HV") %>% select(Task_Visit_Type) %>%
  filter(Task_Visit_Type=="v1") %>% nrow() %>% as.numeric()
denominator_hv_v2 <- c(0)
denominator_hv_v3 <- c(0)
denominator_hv_v4 <- fu_dates %>% filter(Participant_Type2=="HV") %>% select(month12_past) %>%
  filter(month12_past=="TRUE") %>% nrow() %>% as.numeric()

#### calculating the numerators
## MDD
numerator_mdd_v2 <- mid_long %>% filter(Participant_Type2=="MDD") %>% select(Task_Visit_Type) %>%
  filter(Task_Visit_Type=="v2") %>% nrow() %>% as.numeric()
numerator_mdd_v3 <- mid_long %>% filter(Participant_Type2=="MDD") %>% select(Task_Visit_Type) %>%
  filter(Task_Visit_Type=="v3") %>% nrow() %>% as.numeric()
numerator_mdd_v4 <- mid_long %>% filter(Participant_Type2=="MDD") %>% select(Task_Visit_Type) %>%
  filter(Task_Visit_Type=="v4") %>% nrow() %>% as.numeric()
## HV
numerator_hv_v2 <- mid_long %>% filter(Participant_Type2=="HV") %>% select(Task_Visit_Type) %>%
  filter(Task_Visit_Type=="v2") %>% nrow() %>% as.numeric()
numerator_hv_v3 <- mid_long %>% filter(Participant_Type2=="HV") %>% select(Task_Visit_Type) %>%
  filter(Task_Visit_Type=="v3") %>% nrow() %>% as.numeric()
numerator_hv_v4 <- mid_long %>% filter(Participant_Type2=="HV") %>% select(Task_Visit_Type) %>%
  filter(Task_Visit_Type=="v4") %>% nrow() %>% as.numeric()

#### combining
combined <- tibble(Visit= c("Baseline", "4 months", "8 months", "1 year"), 
                   MDD_actual = c(denominator_mdd_v1, numerator_mdd_v2, numerator_mdd_v3, numerator_mdd_v4), 
                   MDD_expected = c(denominator_mdd_v1, denominator_mdd_v2, denominator_mdd_v3, denominator_mdd_v4), 
                   HV_actual = c(denominator_hv_v1, numerator_hv_v2, numerator_hv_v3, numerator_hv_v4), 
                   HV_expected = c(denominator_hv_v1, denominator_hv_v2, denominator_hv_v3, denominator_hv_v4)) %>% 
  mutate(Total_actual = MDD_actual + HV_actual, Total_expected = MDD_expected + HV_expected) %>% 
  mutate(MDD_percent = round(((MDD_actual/MDD_expected)*100),2), 
         HV_percent = round(((HV_actual/HV_expected)*100),2), 
         Total_percent = round(((Total_actual/Total_expected)*100),2)) %>% 
  select(Visit, MDD_actual, MDD_expected, MDD_percent, 
         HV_actual, HV_expected, HV_percent,
         Total_actual, Total_expected, Total_percent)

combined$HV_percent <- gsub("Inf", "", combined$HV_percent)

```

```{r echo=FALSE, warning=FALSE, message=FALSE}

combined %>% kable(., col.names = c("Scan Type", "MDD completed", "MDD expected", "%", 
                                    "HV completed", "HV expected", "%", "Total completed", "Total expected", "%")) %>% 
  kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

```

***

##### SUPREME:

```{r echo=FALSE, warning=FALSE, message=FALSE, results="hide" }

supreme <- task_reshape_master_QC %>% filter(Task_Name == "Supreme") %>% 
  filter(Participant_Type2 =="MDD" | Participant_Type2 == "HV") %>%
  filter(!is.na(Task_Number) & Task_Number != "777" & Task_Number != "999") 

supreme_tot <- supreme %>% nrow() %>% as.numeric()
supreme_tot_row <- tibble(Participant_Type2=c("Total"), Number=c(supreme_tot))
supreme_table <- table(supreme$Participant_Type2) %>% as.data.frame() %>%
  rename(Number = "Freq", Participant_Type2 = "Var1") 
supreme_table <- rbind(supreme_table, supreme_tot_row) %>% 
  mutate(Percent = ((Number/supreme_tot) * 100)) %>% mutate(Percent = round(Percent, 2))

rm(supreme, supreme_tot, supreme_tot_row)

```

```{r echo=FALSE, warning=FALSE, message=FALSE}

supreme_table %>% kable(., col.names = c("Diagnosis", "Number", "%")) %>%
  kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

```

***

##### MEG:

Current MEG - MMI 

```{r echo=FALSE, warning=FALSE, message=FALSE, results="hide" }

meg_mmi <- task_reshape_master_QC %>% filter((Task_Name == "MEG_MMI") | (Task_Name == "MEG_Resting_state") | (Task_Name == "MEG_Empty_Room")) %>% 
  filter(Participant_Type2 =="MDD" | Participant_Type2 == "HV") %>%
  filter(Age_at_visit>11) %>% filter(!is.na(Task_Number) & Task_Number != "777" & Task_Number != "999") 

meg_mmi_past <- meg_mmi %>% filter(Task_Date < todays_date_formatted) %>% select(Initials, Participant_Type2, Task_Name, Task_Date) %>% 
  distinct(., .keep_all = TRUE) 
meg_mmi_past$ID <- seq.int(nrow(meg_mmi_past))

meg_mmi_past <- meg_mmi_past %>% spread(., key = "Task_Name", value = "Task_Date") %>% select(-ID) %>% group_by(Initials) %>% 
  fill(MEG_MMI:MEG_Resting_state, .direction = "down") %>% fill(MEG_MMI:MEG_Resting_state, .direction = "up") %>% 
  ungroup() %>% filter(!is.na(MEG_MMI)) %>% distinct(., .keep_all = TRUE) %>% 
  mutate(MEG_complete=(MEG_MMI==MEG_Resting_state)) %>% mutate(MEG_complete=as.character(MEG_complete))
meg_mmi_past <- meg_mmi_past %>% mutate(MEG_complete = replace_na(MEG_complete, "FALSE"))
meg_mmi_past <- meg_mmi_past %>% group_by(Initials, MEG_MMI) %>% arrange(MEG_complete) %>% slice(n()) %>% ungroup()
  
meg_mmi_table <- ctable(meg_mmi_past$Participant_Type2, meg_mmi_past$MEG_complete, useNA = "no", prop="r", totals=FALSE, display.type=FALSE) %>% 
  as.data.frame() %>% rename(Freq = "cross_table.Freq") %>% rename(Participant_Type2 = "cross_table.meg_mmi_past.Participant_Type2") %>% 
  rename(MEG_complete = "cross_table.meg_mmi_past.MEG_complete") %>% select(-proportions.Total)

meg_mmi_table2 <- reshape(meg_mmi_table, idvar = "Participant_Type2", timevar = "MEG_complete", direction = "wide") %>%
  mutate(FALSE_Percent = (proportions.FALSE.FALSE * 100)) %>% mutate(FALSE_Percent = round(FALSE_Percent, 2)) %>%
  mutate(TRUE_Percent = (proportions.TRUE.TRUE * 100)) %>% mutate(TRUE_Percent = round(TRUE_Percent, 2)) %>%
  select(Participant_Type2, Freq.TRUE, TRUE_Percent, Freq.FALSE, FALSE_Percent, Freq.Total)

```

```{r echo=FALSE, warning=FALSE, message=FALSE}

meg_mmi_table2 %>% kable(., col.names = c("Diagnosis", "Complete", "%", "Incomplete", "%", "Total")) %>% 
  kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

```

```{r echo=FALSE, warning=FALSE, message=FALSE, results="hide" }

meg_mmi_upcoming <- task_reshape_master_QC %>% filter(Task_Name == "MEG_MMI") %>% 
  filter(Task_Date >= todays_date_formatted) %>% select(Initials, Task_Date)
meg_mmi_upcoming$Task_Date <- format(meg_mmi_upcoming$Task_Date, "%B %d %Y")

if (nrow(meg_mmi_upcoming)=="0") {
  meg_mmi_upcoming <- rbind(meg_mmi_upcoming, tibble(Initials=c("No upcoming MEG scheduled"), Task_Date=c(NA)))
  }

meg_mprage_missing <- MEG_mprage %>% select(Initials, Task_Date) 
meg_mprage_missing$Days_since_scan <- as.numeric(difftime(meg_mprage_missing$Task_Date, todays_date_formatted, tz="", units = "days"))

if (nrow(meg_mprage_missing)=="0") {
  meg_mprage_missing <- rbind(meg_mprage_missing, tibble(Initials=c("No upcoming MEG scheduled"), Task_Date=c(NA), Days_since_scan=c(NA)))
  }

rm(meg_mmi, meg_mmi_past, meg_mmi_table)

```

Upcoming MEG - MMI

```{r echo=FALSE, warning=FALSE, message=FALSE}

meg_mmi_upcoming %>% kable(., col.names = c("Initials", "Date")) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```

MEG MPRAGE pending

```{r echo=FALSE, warning=FALSE, message=FALSE}

meg_mprage_missing %>% kable(., col.names = c("Initials", "MEG Date", "Days since MEG")) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```

***

##### Bloods:

```{r echo=FALSE, warning=FALSE, message=FALSE, results="hide" }

bloods <- task_reshape_master_QC %>% filter(str_detect(Task_Name, "lood")) %>% filter(Participant_Type2 =="MDD" | Participant_Type2 == "HV") %>%
  filter(Age_at_visit>11) %>% filter(!is.na(Task_Number) & Task_Number != "777" & Task_Number != "999") %>% 
  filter(Task_Date < todays_date_formatted)

bloods_clinical_rows <- bloods %>% filter(Clinical_Visit_Code == "c")

bloods_inpatient_rows <- bloods %>% filter(Clinical_Visit_Code == "i")

bloods_table <- ctable(bloods$Task_Number, bloods$Clinical_Visit_Code, useNA = "no", prop="r", totals=FALSE, display.type=FALSE) %>% 
  as.data.frame() %>% rename(Freq = "cross_table.Freq") %>% rename(Clinical_Visit_Code = "cross_table.bloods.Clinical_Visit_Code") %>% 
  rename(Task_Number = "cross_table.bloods.Task_Number") %>% select(-proportions.Total)

# Create dummy variables to check if code is running correctly and how to run the next few code chunks - LE practice 

do_next_chunk <- FALSE
do_next_chunk_2 <- FALSE
do_next_chunk_3 <- FALSE
do_next_chunk_4 <- FALSE

# Check each possibility of combinations of clinical and inpatient visit codes - LE practice

if((nrow(bloods_inpatient_rows) > 0)&(nrow(bloods_clinical_rows) > 0)){
  do_next_chunk <- TRUE
}

if ((nrow(bloods_clinical_rows)==0)&(nrow(bloods_inpatient_rows) > 0)){
  do_next_chunk_2 <-TRUE
} 

if ((nrow(bloods_clinical_rows) > 0)&(nrow(bloods_inpatient_rows)==0)){
  do_next_chunk_3 <-TRUE
} 

if ((nrow(bloods_clinical_rows)==0)&(nrow(bloods_inpatient_rows)==0)){
  do_next_chunk_4 <-TRUE
} 

```

```{r echo=FALSE, warning=FALSE, message=FALSE, results="hide", eval=do_next_chunk}

bloods_table2 <- reshape(bloods_table, idvar = "Task_Number", timevar = "Clinical_Visit_Code", direction = "wide") %>% 
   mutate(c_Percent = (proportions.c.c * 100)) %>% mutate(c_Percent = round(c_Percent, 2)) %>%
   mutate(i_Percent = (proportions.i.i * 100)) %>% mutate(i_Percent = round(i_Percent, 2)) %>%
   select(Task_Number, Freq.i, i_Percent, Freq.c, c_Percent, Freq.Total)

rm(bloods, bloods_clinical_rows, bloods_inpatient_rows, bloods_table)

```

```{r echo=FALSE, warning=FALSE, message=FALSE, results="hide", eval=do_next_chunk_2}

bloods_table2 <- reshape(bloods_table, idvar = "Task_Number", timevar = "Clinical_Visit_Code", direction = "wide") %>% 
  mutate(c_Percent = 0) %>% mutate(c_Percent = round(c_Percent, 2)) %>%
  mutate(Freq.c=0) %>%
  mutate(i_Percent = (proportions.i.i * 100)) %>% mutate(i_Percent = round(i_Percent, 2)) %>%
  select(Task_Number, Freq.i, i_Percent, Freq.c, c_Percent, Freq.Total)

rm(bloods, bloods_clinical_rows, bloods_inpatient_rows, bloods_table)
    
```

```{r echo=FALSE, warning=FALSE, message=FALSE, results="hide", eval=do_next_chunk_3}

bloods_table2 <- reshape(bloods_table, idvar = "Task_Number", timevar = "Clinical_Visit_Code", direction = "wide") %>% 
  mutate(c_Percent = (proportions.c.c * 100)) %>% mutate(c_Percent = round(c_Percent, 2)) %>%
  mutate(i_Percent = 0) %>% mutate(c_Percent = round(c_Percent, 2)) %>%
  mutate(Freq.i=0) %>%
  select(Task_Number, Freq.i, i_Percent, Freq.c, c_Percent, Freq.Total)

rm(bloods, bloods_clinical_rows, bloods_inpatient_rows, bloods_table)
    
```

```{r echo=FALSE, warning=FALSE, message=FALSE, results="hide", eval=do_next_chunk_4}

bloods_table2 <- reshape(bloods_table, idvar = "Task_Number", timevar = "Clinical_Visit_Code", direction = "wide") %>% 
  mutate(c_Percent = 0)) %>% mutate(c_Percent = round(c_Percent, 2)) %>%
  mutate(Freq.c=0)
  mutate(i_Percent = 0) %>% mutate(c_Percent = round(c_Percent, 2)) %>%
  mutate(Freq.i=0) %>%
  select(Task_Number, Freq.i, i_Percent, Freq.c, c_Percent, Freq.Total)

rm(bloods, bloods_clinical_rows, bloods_inpatient_rows, bloods_table)
    
```

```{r echo=FALSE, warning=FALSE, message=FALSE}

bloods_table2 %>% kable(., col.names = c("Task Number", "Inpatient", "%", "Characterization", "%", "Total")) %>% 
  kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

```

***

##### Family History Interview completion:

Numbers as of last SDQ+ pull (`r Psychometrics_date`). 

```{r echo=FALSE, warning=FALSE, message=FALSE, results="hide" }

eligible <- master_IRTA_latest %>% select(Initials, Clinical_Visit_Date, Participant_Type, IRTA_tracker, Eligible, Protocol) %>% 
  group_by(Initials) %>% arrange(Initials, Clinical_Visit_Date) %>% fill(Participant_Type:Protocol, .direction = "down") %>% 
  slice(n()) %>% ungroup() %>% filter(str_detect(Protocol, "0037")) %>% filter(!str_detect(Protocol, "SCREENING")) %>% 
  filter(IRTA_tracker != "REMOVED") %>% filter(Eligible != "4" & Eligible !="7" & Eligible !="3" & Eligible !="2") %>% 
  filter(!str_detect(Participant_Type, "Fox")) %>% select(Initials, IRTA_tracker)
eligible <- Psychometrics_treatment %>% select(Initials, c_ksadsdx_primary_dx, c_ksadsdx_date) %>% group_by(Initials) %>% 
  arrange(Initials, c_ksadsdx_date) %>% slice(n()) %>% ungroup() %>% select(-c_ksadsdx_date) %>% left_join(eligible, ., all = TRUE)

family_hist <- merge.default(family_hist, eligible, all = TRUE)
family_hist$c_ksadsdx_primary_dx <- gsub("Anxious", "Other", family_hist$c_ksadsdx_primary_dx)
family_hist$c_ksadsdx_primary_dx <- gsub("EXCLUDED", "Other", family_hist$c_ksadsdx_primary_dx)
family_hist <- family_hist %>% group_by(Initials) %>% fill(c_ksadsdx_primary_dx, c_family_interview_date, c_family_interview_interviewer, .direction="up") %>% 
  fill(c_ksadsdx_primary_dx, c_family_interview_date, c_family_interview_type, c_family_interview_interviewer, .direction="down") %>% ungroup() %>% distinct(., .keep_all = TRUE)
family_hist$c_ksadsdx_primary_dx <- replace_na(family_hist$c_ksadsdx_primary_dx, "Other")
#probably the folloiwng lines can be commented out
family_hist$complete <- is.na(family_hist$c_family_interview_interviewer) %>% as.character()
family_hist$complete <- gsub("FALSE", "Complete", family_hist$complete)
family_hist$complete <- gsub("TRUE", "Incomplete", family_hist$complete)

# family_hist_table <- ctable(family_hist$c_ksadsdx_primary_dx, family_hist$complete, useNA = "no", prop="r", totals=FALSE, display.type=FALSE) %>% 
#   as.data.frame() %>% rename(Freq = "cross_table.Freq") %>% rename(c_ksadsdx_primary_dx = "cross_table.family_hist.c_ksadsdx_primary_dx") %>%
#   rename(complete = "cross_table.family_hist.complete") %>% select(-proportions.Total)
# 
# family_hist_table2 <- reshape(family_hist_table, idvar = "c_ksadsdx_primary_dx", timevar = "complete", direction = "wide") %>%
# mutate(Complete_Percent = (proportions.Complete.Complete * 100)) %>% mutate(Complete_Percent = round(Complete_Percent, 2)) %>%
# mutate(Gaveup_Percent = (proportions.Incomplete.Incomplete * 100)) %>% mutate(Incomplete_Percent = round(Incomplete_Percent, 2)) %>%
# select(c_ksadsdx_primary_dx, Freq.Complete, Complete_Percent, Freq.Incomplete, Incomplete_Percent, Freq.Total)

family_hist$c_family_interview_type=sapply(family_hist$c_family_interview_type, replace_na, "incomplete")
family_hist$c_family_interview_type=as.factor(family_hist$c_family_interview_type)
#this is in case of the levels wasn't in the data
levels(family_hist$c_family_interview_type) <- c(list(complete="complete",incomplete="incomplete", gave_up="gave_up",refusal="refusal")) 

family_hist_table <- ctable(family_hist$c_ksadsdx_primary_dx, family_hist$c_family_interview_type, useNA = "no", prop="r", totals=FALSE, display.type=FALSE) %>% 
  as.data.frame() %>% rename(Freq = "cross_table.Freq") %>% rename(c_ksadsdx_primary_dx = "cross_table.family_hist.c_ksadsdx_primary_dx") %>%
  rename(c_family_interview_type = "cross_table.family_hist.c_family_interview_type") %>% select(-proportions.Total)

family_hist_table2 <- reshape(family_hist_table, idvar = "c_ksadsdx_primary_dx", timevar = "c_family_interview_type", direction = "wide") %>% 
  mutate(Complete_Percent = (proportions.complete.complete * 100)) %>% mutate(Complete_Percent = round(Complete_Percent, 2)) %>% 
  mutate(GaveUp_Percent = (proportions.gave_up.gave_up * 100)) %>% mutate(GaveUp_Percent = round(GaveUp_Percent, 2)) %>% 
  mutate(Refusal_Percent = (proportions.refusal.refusal * 100)) %>% mutate(Refusal_Percent = round(Refusal_Percent, 2)) %>% 
  mutate(Incomplete_Percent = (proportions.incomplete.incomplete * 100)) %>% mutate(Incomplete_Percent = round(Incomplete_Percent, 2)) %>% 
  select(c_ksadsdx_primary_dx, Freq.complete, Complete_Percent, Freq.gave_up, GaveUp_Percent, Freq.refusal, Refusal_Percent, Freq.incomplete, Incomplete_Percent, Freq.Total)

rm(family_hist, family_hist_table, eligible)

```

```{r echo=FALSE, warning=FALSE, message=FALSE}

 #family_hist_table2 %>% kable(., col.names = c("Diagnosis", "Complete", "%", "Incomplete", "%", "Total")) %>% 
family_hist_table2 %>% kable(., col.names = c("Diagnosis", "Complete", "%", "No longer following", "%","Refused", "%","Incomplete", "%", "Total")) %>% 
  kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

```

***
##### CRISIS Data:
Child CRISIS Summary Data:

```{r echo=FALSE, warning=FALSE, message=FALSE}
CRISISsent=read.csv(paste0(database_location, "/COVID19/Summary Numbers/2021-01-04/crisis_sent.csv"))
#"Number of subjects with Pre-Covid data: 182"
#CRISISsent
#CRISISsent %>% kable(., col.names = c("Dates", "CRISIS sent", "CRISIS sent with PreCovid Data")) %>% 
#  kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

#this has covid data too
# covidAndCrisis=read.csv(paste0(database_location, "/COVID19/Summary Numbers/2021-01-06/crisisAndCovid_numbers_basedOn_CrisisTminus1_precovidPlusIds_2021-01-06.csv"))
# covidAndCrisis=covidAndCrisis[3:10,]

covidAndCrisis=read.csv(paste0(database_location, "/COVID19/Summary Numbers/2021-01-07_just_crisis/crisisAndCovid_numbers_basedOn_CrisisTminus1_precovidPlusIds_2021-01-07.csv"))
summaryOfCovidAndCrisis=cbind(as.character(covidAndCrisis[,1]), covidAndCrisis[,2],covidAndCrisis[,4]+ covidAndCrisis[,7],covidAndCrisis[,5]+ covidAndCrisis[,8])
#colnames(summaryOfCovidAndCrisis)=c("Dates", "Completed CRISIS", "and have PreCovid Data", "and Completed MFQ+Scared")
summaryOfCovidAndCrisis %>% kable(., col.names = c("Dates", "Total CRISIS completed","and MFQ/Scared before 03/17/2019", "and completed MFQ and SCARED")) %>%
   kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))
#covidAndCrisis[3:9,1:7]

# combinedCRISIS=cbind(CRISISsent[,1:2],CRISISsent[,3], covidAndCrisis[3:9,2], (covidAndCrisis[3:9,5]+covidAndCrisis[3:9,8]))
# colnames(combinedCRISIS)=c("Dates", "Potentially Sent", "+PreCovid Data", "+ Completed CRISIS", "+ Completed MFQ+Scared")
# combinedCRISIS
```

Parent CRISIS Summary Data:

```{r echo=FALSE, warning=FALSE, message=FALSE}
covidAndCrisis=read.csv(paste0(database_location, "/COVID19/Summary Numbers/2021-01-07_just_crisis/parent_crisisAndCovid_numbers_basedOn_CrisisTminus1_precovidPlusIds_2021-01-07.csv"))
summaryOfCovidAndCrisis=cbind(as.character(covidAndCrisis[,1]), covidAndCrisis[,2],covidAndCrisis[,4]+ covidAndCrisis[,7],covidAndCrisis[,5]+ covidAndCrisis[,8])
#colnames(summaryOfCovidAndCrisis)=c("Dates", "Completed CRISIS", "and have PreCovid Data", "and Completed MFQ+Scared")
summaryOfCovidAndCrisis %>% kable(., col.names = c("Dates", "Total CRISIS completed","and MFQ/Scared before 03/17/2019", "and completed MFQ and SCARED")) %>%
   kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

```

<!-- #Child CRISIS Summary Data: -->
<!-- ```{r echo=FALSE, warning=FALSE, message=FALSE} -->
<!-- covidAndCrisis=read.csv(paste0(database_location, "/COVID19/Summary Numbers/2021-01-07_just_crisis/child_crisisAndCovid_numbers_basedOn_CrisisTminus1_precovidPlusIds_2021-01-07.csv")) -->
<!-- covidAndCrisis %>% kable(., col.names = c("Dates", "Total CRISIS completed","and MFQ/Scared before 03/17/2019", "and wave MFQ", "and wave SCARED")) %>%  -->
<!--   kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed")) -->
<!-- ``` -->

<!-- #Parent CRISIS Summary Data: -->
<!-- ```{r echo=FALSE, warning=FALSE, message=FALSE} -->
<!-- covidAndCrisis=read.csv(paste0(database_location, "/COVID19/Summary Numbers/2021-01-07_just_crisis/parent_crisisnumbers_basedOn_CrisisTminus1_precovidPlusIds_2021-01-07.csv")) -->
<!-- covidAndCrisis %>% kable(., col.names = c("Dates", "Total CRISIS completed","and MFQ/Scared before 03/17/2019", "and wave MFQ", "and wave SCARED")) %>%  -->
<!--   kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed")) -->
<!-- ``` -->

<!-- #Child Summary Data including previous COVID questionnaire -->
<!-- ```{r echo=FALSE, warning=FALSE, message=FALSE} -->
<!-- covidAndCrisis=read.csv(paste0(database_location, "/COVID19/Summary Numbers/2021-01-06/child_crisisAndCovid_numbers_basedOn_CrisisTminus1_precovidPlusIds_2021-01-06.csv")) -->
<!-- covidAndCrisis %>% kable(., col.names = c("Dates", "Total CRISIS completed"," and MFQ/Scared before 03/17/2019", " and wave MFQ", "and wave SCARED")) %>%  -->
<!--   kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed")) -->
<!-- ``` -->
***

##### MMI_recovery task completion (PsychoPy task):

```{r echo=FALSE, warning=FALSE, message=FALSE, results="hide" }

diagnosis <- crisis %>% select(Initials, IRTA_tracker, c_ksadsdx_primary_dx, c_ksadsdx_dx_detailed) %>% 
  group_by(Initials) %>% slice(1) %>% ungroup() 
MMI_recovery_completed <- MMI_recovery_combined2 %>% filter(!is.na(Task_Completed_Date)) %>% left_join(., diagnosis)

# MMI_recovery_table_Dx <- MMI_recovery_completed %>% group_by(Initials) %>% arrange(Task_Completed_Date) %>% 
#   slice(n()) %>% ungroup() %>% group_by(c_ksadsdx_primary_dx) %>% tally() %>% rename(Diagnosis = "c_ksadsdx_primary_dx")

MMI_recovery_table_Dx <- MMI_recovery_completed %>% select(Initials, Task_Completed_Date, c_ksadsdx_primary_dx) %>% distinct(., .keep_all = TRUE) %>% 
  group_by(Initials, c_ksadsdx_primary_dx) %>% tally() %>% rename(Diagnosis = "c_ksadsdx_primary_dx", Num="n") %>% group_by(Diagnosis, Num) %>% 
  tally() %>% ungroup() %>% mutate(row_tot = (Num*n))
MMI_1_total <- MMI_recovery_table_Dx %>% filter(Num==1) %>% select(row_tot) %>% colSums(.) %>% as.numeric()
MMI_2_total <- MMI_recovery_table_Dx %>% filter(Num==2) %>% select(row_tot) %>% colSums(.) %>% as.numeric()
MMI_grand_total <- MMI_recovery_table_Dx %>% select(row_tot) %>% colSums(.) %>% as.numeric()
MMI_totals <- tibble(Diagnosis=c("Total once", "Total twice", "Grand total"), Num=c(1, 2, NA), n=c(NA), row_tot=c(MMI_1_total, MMI_2_total, MMI_grand_total))
MMI_recovery_table_Dx <- rbind(MMI_recovery_table_Dx, MMI_totals) %>% select(-n)

MMI_recovery_latest <- MMI_recovery_completed %>% group_by(Initials) %>% arrange(Task_Completed_Date) %>% slice(n()) %>% ungroup() %>% 
  filter(Task_Completed_Date > last_week_date_formatted) %>% group_by(c_ksadsdx_primary_dx) %>% tally() %>% rename(Diagnosis = "c_ksadsdx_primary_dx")
MMI_recovery_latest_total <- MMI_recovery_latest %>% select(n) %>% colSums() %>% as.numeric() %>% 
  as.data.frame() %>% rename(n = ".") %>% mutate(Diagnosis = "Total") %>% select(Diagnosis, n)
MMI_recovery_latest <- rbind(MMI_recovery_latest, MMI_recovery_latest_total)

rm(MMI_recovery_completed, diagnosis, MMI_recovery_total, MMI_recovery_latest_total)

```

Overall:

```{r echo=FALSE, warning=FALSE, message=FALSE}

MMI_recovery_table_Dx %>% kable(., col.names = c("Diagnosis", "Number of times completed", "Total")) %>%
  kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

```

In the past week: 

```{r echo=FALSE, warning=FALSE, message=FALSE}

MMI_recovery_latest %>% kable(., col.names = c("Diagnosis", "Freq")) %>%
  kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

```

***

#### 3. Treatment Numbers 

***

##### Outpatient enrollment:

```{r echo=FALSE, warning=FALSE, message=FALSE, results="hide" }

outpatients <- master_IRTA_latest %>% filter(Clinical_Visit_Code=="o") %>% group_by(Initials) %>% arrange(Initials, Clinical_Visit_Date) %>% 
  slice(n()) %>% ungroup()
outpatients$Eligible <- recode(outpatients$Eligible, "0"="Active in treatment", 
      "2"="On hold: contact again after specified amount of time", 
      "5"="Excluded after commencing treatment: some treatment received before participant was later excluded (e.g. bad scanner, now meets exclusionary criteria, etc.)",
      "6"="Excluded after commencing treatment: some treatment received before participant was later excluded (e.g. bad scanner, now meets exclusionary criteria, etc.)",
      "7"="Patient (or parent) withdrew from treatment", 
      "8"="Ruled as ineligible for treatment during baseline assessment (didn't meet inclusionary or met exclusionary criteria)",
      "9"="Patient (or parent) withdrew from treatment", 
      "10"="Excluded after commencing treatment: some treatment received before participant was later excluded (e.g. bad scanner, now meets exclusionary criteria, etc.)", 
      "11"="Completed treatment", .missing = NULL)

outpatients_tot <- outpatients %>% nrow() %>% as.numeric()
outpatients_total_table <- tibble(Eligible=c("Total"), Number=c(outpatients_tot))
outpatients_table <- table(outpatients$Eligible) %>% as.data.frame() %>%
  rename(Number = "Freq", Eligible = "Var1") %>% mutate(Eligible=as.character(Eligible))

outpatients_table <- rbind(outpatients_table, outpatients_total_table) %>% 
  mutate(Status_percent = ((Number/outpatients_tot) * 100)) %>% mutate(Status_percent = round(Status_percent, 2)) 

```

```{r echo=FALSE, warning=FALSE, message=FALSE}

outpatients_table %>% kable(., col.names = c("Treatment status", "Frequency", "%")) %>%
  kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

```

Current CBT participants: 

```{r echo=FALSE, warning=FALSE, message=FALSE, results="hide" }

current_outpatients <- outpatients %>% filter(Eligible=="Active in treatment") %>% 
  select(Initials, Clinical_Visit_Date, Clinical_Visit_Number, IRTA_tracker)
current_outpatients$Clinical_Visit_Date <- format(current_outpatients$Clinical_Visit_Date, "%B %d %Y")

if (nrow(current_outpatients)=="0") {
  current_outpatients <- rbind(current_outpatients, tibble(Initials=c("None currently in treatment"), Clinical_Visit_Date=c(NA), 
                                                           Clinical_Visit_Number=c(NA), IRTA_tracker=c(NA)))
  }

rm(outpatients_tot, outpatients_total_table)

```

```{r echo=FALSE, warning=FALSE, message=FALSE}

current_outpatients %>% kable(., col.names = c("Initials", "Last/Next CBT Date", "Visit Number", "Scheduling IRTA")) %>% 
  kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

```

***

##### Inpatients:

```{r echo=FALSE, warning=FALSE, message=FALSE, results="hide" }

inpatients <- master_IRTA_latest %>% filter(Clinical_Visit_Code=="i") %>% group_by(Initials) %>% arrange(Initials, Clinical_Visit_Date) %>% 
  slice(n()) %>% ungroup()
inpatients$Eligible <- recode(inpatients$Eligible, "0"="Active in treatment", 
      "2"="On hold: contact again after specified amount of time", 
      "5"="Excluded after commencing treatment: some treatment received before participant was later excluded (e.g. bad scanner, now meets exclusionary criteria, etc.)",
      "6"="Excluded after commencing treatment: some treatment received before participant was later excluded (e.g. bad scanner, now meets exclusionary criteria, etc.)",
      "7"="Patient (or parent) withdrew from treatment", 
      "8"="Ruled as ineligible for treatment during baseline assessment (didn't meet inclusionary or met exclusionary criteria)",
      "9"="Patient (or parent) withdrew from treatment", 
      "10"="Excluded after commencing treatment: some treatment received before participant was later excluded (e.g. bad scanner, now meets exclusionary criteria, etc.)", 
      "11"="Completed treatment", .missing = NULL)

inpatients_tot <- inpatients %>% nrow() %>% as.numeric()
inpatients_total_table <- tibble(Eligible=c("Total"), Number=c(inpatients_tot))
inpatients_table <- table(inpatients$Eligible) %>% as.data.frame() %>%
  rename(Number = "Freq", Eligible = "Var1") %>% mutate(Eligible=as.character(Eligible))

inpatients_table <- rbind(inpatients_table, inpatients_total_table) %>% 
  mutate(Status_percent = ((Number/inpatients_tot) * 100)) %>% mutate(Status_percent = round(Status_percent, 2)) 

```

```{r echo=FALSE, warning=FALSE, message=FALSE}

inpatients_table %>% kable(., col.names = c("Treatment status", "Frequency", "%")) %>%
  kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

```

Current inpatients: 

```{r echo=FALSE, warning=FALSE, message=FALSE, results="hide" }

current_inpatients <- inpatients %>% filter(is.na(Eligible) | Eligible=="Active in treatment") %>% 
  select(Initials, Clinical_Visit_Date, Clinical_Visit_Number, IRTA_tracker)
current_inpatients$Clinical_Visit_Date <- format(current_inpatients$Clinical_Visit_Date, "%B %d %Y")

if (nrow(current_inpatients)=="0") {
  current_inpatients <- rbind(current_inpatients, tibble(Initials=c("None currently in treatment"), Clinical_Visit_Date=c(NA), 
                                                           Clinical_Visit_Number=c(NA), IRTA_tracker=c(NA)))
  }

rm(inpatients_tot, inpatients_total_table)

```

```{r echo=FALSE, warning=FALSE, message=FALSE}

current_inpatients %>% kable(., col.names = c("Initials", "Last Week Recorded", "Week Number", "Scheduling IRTA")) %>% 
  kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

```

***

\pagebreak

```{r echo=FALSE, warning=FALSE, message=FALSE, results="hide" }

rm(screens_table2, screens_current_table, ready_2_review, scheduled, scheduling_table2, protocol_table2, MMI_recovery_table_IRTA, 
  MMI_recovery_table_participant, inpatients_table, combined, meg_mmi_table2, meg_mmi_upcoming, bloods_table2, MDD_6_months, HV_6_months, 
  current_outpatients, current_inpatients, outpatients, outpatients_table, inpatients, family_hist_table2, crisis_reformatted, supreme_table, 
  meg_mprage_missing, diag_mid_3_table, fu_dates, mid_long, six_months_3TA, six_months_3TC)
rm(list=ls(pattern="denominator_"))
rm(list=ls(pattern="numerator_"))
rm(list=ls(pattern="parent_completed_"))
rm(list=ls(pattern="child_completed_"))

```
