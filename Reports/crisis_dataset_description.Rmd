---
title: "CRISIS dataset"
output: 
  html_document:
    df_print: paged
  word_document:
    fig_caption: yes
    fig_height: 5
    fig_width: 8
header-includes:
- \usepackage{booktabs}
- \usepackage{longtable}
- \usepackage{array}
- \usepackage{multirow}
- \usepackage{wrapfig}
- \usepackage{float}
- \usepackage{colortbl}
- \usepackage{pdflscape}
- \usepackage{tabu}
- \usepackage{threeparttable}
- \usepackage{threeparttablex}
- \usepackage[normalem]{ulem}
- \usepackage{makecell}
- \usepackage{xcolor}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# !diagnostics off
```

```{r echo=FALSE, warning=FALSE, message=FALSE, results="hide" }

# Loading data ------------------------------------------------------------

todays_date <- todays_date_formatted %>% format(., "%B %d %Y")

if (exists("Psychometrics_treatment")==FALSE) {
        master_database_file <- list.files(path = paste0(database_location), pattern = "^MASTER_DATABASE_CLINICAL", all.files = FALSE,
                                 full.names = FALSE, recursive = FALSE, ignore.case = FALSE, include.dirs = FALSE, no.. = FALSE)
        master_database_file_time <- file.mtime(paste0(database_location, "/", master_database_file)) %>% as.Date()
        master_database_combined <- tibble(File=c(master_database_file), Date=c(master_database_file_time)) %>% 
          arrange(desc(Date)) %>% slice(1)
        Psychometrics_treatment <- read_excel(paste0(database_location, master_database_combined[1]))
        rm(master_database_file, master_database_file_time, master_database_combined)
} else {
        print("clinical database info already imported")
}

date_variables <- Psychometrics_treatment %>% select(matches("_date"), matches("_Date")) %>% colnames()
Psychometrics_treatment[date_variables] <- lapply(Psychometrics_treatment[date_variables], as.Date)

if (exists("Psychometrics_behav")==FALSE) {
        master_database_file <- list.files(path = paste0(database_location), pattern = "^MASTER_DATABASE_BEHAVIOURAL", all.files = FALSE,
                                 full.names = FALSE, recursive = FALSE, ignore.case = FALSE, include.dirs = FALSE, no.. = FALSE)
        master_database_file_time <- file.mtime(paste0(database_location, "/", master_database_file)) %>% as.Date()
        master_database_combined <- tibble(File=c(master_database_file), Date=c(master_database_file_time)) %>% 
          arrange(desc(Date)) %>% slice(1)
        Psychometrics_behav <- read_excel(paste0(database_location, master_database_combined[1]))
        rm(master_database_file, master_database_file_time, master_database_combined)
} else {
        print("tasks database info already imported")
}

date_variables <- Psychometrics_behav %>% select(matches("_date"), matches("_Date")) %>% colnames()
Psychometrics_behav[date_variables] <- lapply(Psychometrics_behav[date_variables], as.Date)

if (exists("MMI_recovery_combined2")==FALSE) {
        mmi_recovery_file <- list.files(path = paste0(database_location, "COVID19/"), pattern = "^MMI_recovery_subset", all.files = FALSE,
                                 full.names = FALSE, recursive = FALSE, ignore.case = FALSE, include.dirs = FALSE, no.. = FALSE)
        mmi_recovery_file_time <- file.mtime(paste0(database_location, "COVID19/", mmi_recovery_file)) %>% as.Date()
        mmi_recovery_combined <- tibble(File=c(mmi_recovery_file), Date=c(mmi_recovery_file_time)) %>% 
          arrange(desc(Date)) %>% slice(1)
        MMI_recovery_combined2 <- read_excel(paste0(database_location, "COVID19/", mmi_recovery_combined[1]))
} else {
        print("MMI recovery completion info already imported")
}

# crisis recruitment related
# child_contacted <- c(to_change$child_contacted)
# parent_contacted <- c(to_change$parent_contacted)
# parent_agreed <- c(to_change$parent_agreed)
#![](`r paste0(CBT_location, "images/NIH_logo.png")`)
```



***

#### CRISIS data flow

***

##### DATE: `r todays_date`

```{r echo=FALSE, warning=FALSE, message=FALSE, results="hide" }

measures_completed <- Psychometrics_behav %>% filter(str_detect(Task_Name, "easures")) %>% filter(Task_Date >= "2020-04-06") %>% 
  select(Initials, SDAN, PLUSID, Participant_Type2, IRTA_tracker, Task_Name, Task_Date, SEX, Age_at_visit,
         c_ksadsdx_primary_dx, c_ksadsdx_dx_detailed, s_mfq1w_tot, s_mfq1w_date, s_mfq_tot, s_mfq_date, s_scared_tot, s_scared_date, 
         s_scaredshort_tot, s_scaredshort_date, matches("s_crisis_"), p_mfq1w_tot, p_mfq1w_date, p_mfq_tot, p_mfq_date, p_scared_tot, 
         p_scared_date, p_scaredshort_tot, p_scaredshort_date, matches("p_crisis_")) %>% rename(Age = "Age_at_visit") %>%
  group_by(Initials) %>% mutate(id = row_number()) %>% ungroup() %>% mutate(id = (id + 2)) %>% mutate(Age = round(Age, digits = 0))
measures_completed$s_mfq_tot <- coalesce(measures_completed$s_mfq_tot, measures_completed$s_mfq1w_tot) %>% round(., digits = 0)
measures_completed$p_mfq_tot <- coalesce(measures_completed$p_mfq_tot, measures_completed$p_mfq1w_tot) %>% round(., digits = 0)
measures_completed$s_mfq_date <- coalesce(measures_completed$s_mfq_date, measures_completed$s_mfq1w_date) %>% round(., digits = 0)
measures_completed$p_mfq_date <- coalesce(measures_completed$p_mfq_date, measures_completed$p_mfq1w_date) %>% round(., digits = 0)
measures_completed <- measures_completed %>% select(-s_mfq1w_tot, -p_mfq1w_tot, -s_mfq1w_date, -p_mfq1w_date)

```

```{r echo=FALSE, warning=FALSE, message=FALSE, results="hide" }

child_agreed <- 179 #as of September 23 it's 179, was 177
parent_agreed <- 139

##### all baseline measures completed 
# parent
parent_completed_all_base <- measures_completed %>% filter(!is.na(p_crisis_base_tot)) %>% group_by(Initials) %>% arrange(Initials, Task_Date) %>% 
  slice(1) %>% ungroup() %>% select(Initials, p_mfq_tot, p_scaredshort_tot, p_crisis_base_tot) %>% filter(!is.na(p_mfq_tot) & !is.na(p_scaredshort_tot)) 
parent_completed_all_base_num <- parent_completed_all_base %>% nrow() %>% as.numeric()
# child 
child_completed_all_base <- measures_completed %>% filter(!is.na(s_crisis_base_tot)) %>% group_by(Initials) %>% arrange(Initials, Task_Date) %>% 
  slice(1) %>% ungroup() %>% select(Initials, s_mfq_tot, s_scaredshort_tot, s_crisis_base_tot) %>% filter(!is.na(s_mfq_tot) & !is.na(s_scaredshort_tot))
child_completed_all_base_num <- child_completed_all_base %>% nrow() %>% as.numeric()
##### crisis baseline completed 
# parent
parent_completed_crisis_base <- measures_completed %>% filter(!is.na(p_crisis_base_tot)) %>% group_by(Initials) %>% arrange(Initials, Task_Date) %>% 
  slice(1) %>% ungroup() %>% select(Initials, p_crisis_base_tot)
parent_completed_crisis_base_num <- parent_completed_crisis_base %>% nrow() %>% as.numeric()
# child 
child_completed_crisis_base <- measures_completed %>% filter(!is.na(s_crisis_base_tot)) %>% group_by(Initials) %>% arrange(Initials, Task_Date) %>% 
  slice(1) %>% ungroup() %>% select(Initials, s_crisis_base_tot)
child_completed_crisis_base_num <- child_completed_crisis_base %>% nrow() %>% as.numeric()

##### all followup measures completed (first follow up)
# parent
parent_completed_all_fu1 <- measures_completed %>% filter(!is.na(p_crisis_fu_tot)) %>% group_by(Initials) %>% arrange(Initials, Task_Date) %>% 
  slice(1) %>% ungroup() %>% select(Initials, p_mfq_tot, p_scaredshort_tot, p_crisis_fu_tot) %>% filter(!is.na(p_mfq_tot) & !is.na(p_scaredshort_tot))
parent_completed_all_fu_num1 <- parent_completed_all_fu1 %>% nrow() %>% as.numeric() 
# child 
child_completed_all_fu1 <- measures_completed %>% filter(!is.na(s_crisis_fu_tot)) %>% group_by(Initials) %>% arrange(Initials, Task_Date) %>% 
  slice(1) %>% ungroup() %>% select(Initials, s_mfq_tot, s_scaredshort_tot, s_crisis_fu_tot) %>% filter(!is.na(s_mfq_tot) & !is.na(s_scaredshort_tot))
child_completed_all_fu_num1 <- child_completed_all_fu1 %>% nrow() %>% as.numeric() 
##### crisis followup completed 
# parent
parent_completed_crisis_fu1 <- measures_completed %>% filter(!is.na(p_crisis_fu_tot)) %>% group_by(Initials) %>% arrange(Initials, Task_Date) %>% 
  slice(1) %>% ungroup() %>% select(Initials, p_crisis_fu_tot)
parent_completed_crisis_fu_num1 <- parent_completed_crisis_fu1 %>% nrow() %>% as.numeric() 
# child 
child_completed_crisis_fu1 <- measures_completed %>% filter(!is.na(s_crisis_fu_tot)) %>% group_by(Initials) %>% arrange(Initials, Task_Date) %>% 
  slice(1) %>% ungroup() %>% select(Initials, s_crisis_fu_tot)
child_completed_crisis_fu_num1 <- child_completed_crisis_fu1 %>% nrow() %>% as.numeric() 
##### all followup measures completed (second follow up)
# parent
parent_completed_all_fu2 <- measures_completed %>% filter(!is.na(p_crisis_fu_tot)) %>% group_by(Initials) %>% arrange(Initials, Task_Date) %>% filter(n()>1) %>% 
  slice(2) %>% ungroup() %>% select(Initials, p_mfq_tot, p_scaredshort_tot, p_crisis_fu_tot) %>% filter(!is.na(p_mfq_tot) & !is.na(p_scaredshort_tot))
parent_completed_all_fu_num2 <- parent_completed_all_fu2 %>% nrow() %>% as.numeric() 
# child 
child_completed_all_fu2 <- measures_completed %>% filter(!is.na(s_crisis_fu_tot)) %>% group_by(Initials) %>% arrange(Initials, Task_Date) %>% filter(n()>1) %>% 
  slice(2) %>% ungroup() %>% select(Initials, s_mfq_tot, s_scaredshort_tot, s_crisis_fu_tot) %>% filter(!is.na(s_mfq_tot) & !is.na(s_scaredshort_tot))
child_completed_all_fu_num2 <- child_completed_all_fu2 %>% nrow() %>% as.numeric() 
##### crisis followup completed 
# parent
parent_completed_crisis_fu2 <- measures_completed %>% filter(!is.na(p_crisis_fu_tot)) %>% group_by(Initials) %>% arrange(Initials, Task_Date) %>% filter(n()>1) %>% 
  slice(2) %>% ungroup() %>% select(Initials, p_crisis_fu_tot)
parent_completed_crisis_fu_num2 <- parent_completed_crisis_fu2 %>% nrow() %>% as.numeric() 
# child 
child_completed_crisis_fu2 <- measures_completed %>% filter(!is.na(s_crisis_fu_tot)) %>% group_by(Initials) %>% arrange(Initials, Task_Date) %>% filter(n()>1) %>% 
  slice(2) %>% ungroup() %>% select(Initials, s_crisis_fu_tot)
child_completed_crisis_fu_num2 <- child_completed_crisis_fu2 %>% nrow() %>% as.numeric() 
##### all followup measures completed (third follow up)
# parent
parent_completed_all_fu3 <- measures_completed %>% filter(!is.na(p_crisis_fu_tot)) %>% group_by(Initials) %>% arrange(Initials, Task_Date) %>% filter(n()>2) %>% 
  slice(3) %>% ungroup() %>% select(Initials, p_mfq_tot, p_scaredshort_tot, p_crisis_fu_tot) %>% filter(!is.na(p_mfq_tot) & !is.na(p_scaredshort_tot))
parent_completed_all_fu_num3 <- parent_completed_all_fu3 %>% nrow() %>% as.numeric() 
# child 
child_completed_all_fu3 <- measures_completed %>% filter(!is.na(s_crisis_fu_tot)) %>% group_by(Initials) %>% arrange(Initials, Task_Date) %>% filter(n()>2) %>% 
  slice(3) %>% ungroup() %>% select(Initials, s_mfq_tot, s_scaredshort_tot, s_crisis_fu_tot) %>% filter(!is.na(s_mfq_tot) & !is.na(s_scaredshort_tot))
child_completed_all_fu_num3 <- child_completed_all_fu3 %>% nrow() %>% as.numeric() 
##### crisis followup completed 
# parent
parent_completed_crisis_fu3 <- measures_completed %>% filter(!is.na(p_crisis_fu_tot)) %>% group_by(Initials) %>% arrange(Initials, Task_Date) %>% filter(n()>2) %>% 
  slice(3) %>% ungroup() %>% select(Initials, p_crisis_fu_tot)
parent_completed_crisis_fu_num3 <- parent_completed_crisis_fu3 %>% nrow() %>% as.numeric() 
# child 
child_completed_crisis_fu3 <- measures_completed %>% filter(!is.na(s_crisis_fu_tot)) %>% group_by(Initials) %>% arrange(Initials, Task_Date) %>% filter(n()>2) %>% 
  slice(3) %>% ungroup() %>% select(Initials, s_crisis_fu_tot)
child_completed_crisis_fu_num3 <- child_completed_crisis_fu3 %>% nrow() %>% as.numeric() 
##### all followup measures completed (forth follow up)
# parent
parent_completed_all_fu4 <- measures_completed %>% filter(!is.na(p_crisis_fu_tot)) %>% group_by(Initials) %>% arrange(Initials, Task_Date) %>% filter(n()>3) %>% 
  slice(4) %>% ungroup() %>% select(Initials, p_mfq_tot, p_scaredshort_tot, p_crisis_fu_tot) %>% filter(!is.na(p_mfq_tot) & !is.na(p_scaredshort_tot))
parent_completed_all_fu_num4 <- parent_completed_all_fu4 %>% nrow() %>% as.numeric() 
# child 
child_completed_all_fu4 <- measures_completed %>% filter(!is.na(s_crisis_fu_tot)) %>% group_by(Initials) %>% arrange(Initials, Task_Date) %>% filter(n()>3) %>% 
  slice(4) %>% ungroup() %>% select(Initials, s_mfq_tot, s_scaredshort_tot, s_crisis_fu_tot) %>% filter(!is.na(s_mfq_tot) & !is.na(s_scaredshort_tot))
child_completed_all_fu_num4 <- child_completed_all_fu4 %>% nrow() %>% as.numeric() 
##### crisis followup completed 
# parent
parent_completed_crisis_fu4 <- measures_completed %>% filter(!is.na(p_crisis_fu_tot)) %>% group_by(Initials) %>% arrange(Initials, Task_Date) %>% filter(n()>3) %>% 
  slice(4) %>% ungroup() %>% select(Initials, p_crisis_fu_tot)
parent_completed_crisis_fu_num4 <- parent_completed_crisis_fu4 %>% nrow() %>% as.numeric() 
# child 
child_completed_crisis_fu4 <- measures_completed %>% filter(!is.na(s_crisis_fu_tot)) %>% group_by(Initials) %>% arrange(Initials, Task_Date) %>% filter(n()>3) %>% 
  slice(4) %>% ungroup() %>% select(Initials, s_crisis_fu_tot)
child_completed_crisis_fu_num4 <- child_completed_crisis_fu4 %>% nrow() %>% as.numeric() 

##### all followup measures completed (fifth follow up)
# parent
parent_completed_all_fu5 <- measures_completed %>% filter(!is.na(p_crisis_fu_tot)) %>% group_by(Initials) %>% arrange(Initials, Task_Date) %>% filter(n()>4) %>% 
  slice(5) %>% ungroup() %>% select(Initials, p_mfq_tot, p_scaredshort_tot, p_crisis_fu_tot) %>% filter(!is.na(p_mfq_tot) & !is.na(p_scaredshort_tot))
parent_completed_all_fu_num5 <- parent_completed_all_fu5 %>% nrow() %>% as.numeric() 
# child 
child_completed_all_fu5 <- measures_completed %>% filter(!is.na(s_crisis_fu_tot)) %>% group_by(Initials) %>% arrange(Initials, Task_Date) %>% filter(n()>4) %>% 
  slice(5) %>% ungroup() %>% select(Initials, s_mfq_tot, s_scaredshort_tot, s_crisis_fu_tot) %>% filter(!is.na(s_mfq_tot) & !is.na(s_scaredshort_tot))
child_completed_all_fu_num5 <- child_completed_all_fu5 %>% nrow() %>% as.numeric() 
##### crisis followup completed 
# parent
parent_completed_crisis_fu5 <- measures_completed %>% filter(!is.na(p_crisis_fu_tot)) %>% group_by(Initials) %>% arrange(Initials, Task_Date) %>% filter(n()>4) %>% 
  slice(5) %>% ungroup() %>% select(Initials, p_crisis_fu_tot)
parent_completed_crisis_fu_num5 <- parent_completed_crisis_fu5 %>% nrow() %>% as.numeric() 
# child 
child_completed_crisis_fu5 <- measures_completed %>% filter(!is.na(s_crisis_fu_tot)) %>% group_by(Initials) %>% arrange(Initials, Task_Date) %>% filter(n()>4) %>% 
  slice(5) %>% ungroup() %>% select(Initials, s_crisis_fu_tot)
child_completed_crisis_fu_num5 <- child_completed_crisis_fu5 %>% nrow() %>% as.numeric() 


##### crisis baseline + followup completed, all measures (first follow up)
# parent
parent_completed_all_fu1 <- parent_completed_all_fu1 %>% rename(p_mfq_fu_tot="p_mfq_tot") %>% rename(p_scaredshort_fu_tot="p_scaredshort_tot")
parent_completed_all_both1 <- merge.default(parent_completed_all_base, parent_completed_all_fu1, all=TRUE) %>% 
  filter(!is.na(p_crisis_base_tot)) %>% filter(!is.na(p_crisis_fu_tot))
parent_completed_all_both_num1 <- parent_completed_all_both1 %>% nrow() %>% as.numeric() 
# child 
child_completed_all_fu1 <- child_completed_all_fu1 %>% rename(s_mfq_fu_tot="s_mfq_tot") %>% rename(s_scaredshort_fu_tot="s_scaredshort_tot")
child_completed_all_both1 <- merge.default(child_completed_all_base, child_completed_all_fu1, all=TRUE) %>% 
  filter(!is.na(s_crisis_base_tot)) %>% filter(!is.na(s_crisis_fu_tot))
child_completed_all_both_num1 <- child_completed_all_both1 %>% nrow() %>% as.numeric() 
##### crisis baseline + followup completed, crisis only
# parent
parent_completed_crisis_both1 <- merge.default(parent_completed_crisis_base, parent_completed_crisis_fu1, all=TRUE) %>%
  filter(!is.na(p_crisis_fu_tot)) %>% filter(!is.na(p_crisis_base_tot)) 
parent_completed_crisis_both_num1 <- parent_completed_crisis_both1 %>% nrow() %>% as.numeric() 
# child 
child_completed_crisis_both1 <- merge.default(child_completed_crisis_base, child_completed_crisis_fu1, all=TRUE) %>% 
  filter(!is.na(s_crisis_fu_tot)) %>% filter(!is.na(s_crisis_base_tot))
child_completed_crisis_both_num1 <- child_completed_crisis_both1 %>% nrow() %>% as.numeric() 
##### crisis baseline + followup completed, all measures (second follow up)
# parent
parent_completed_all_fu2 <- parent_completed_all_fu2 %>% rename(p_mfq_fu2_tot="p_mfq_tot") %>% rename(p_scaredshort_fu2_tot="p_scaredshort_tot") %>% 
  rename(p_crisis_fu2_tot="p_crisis_fu_tot")
parent_completed_all_both2 <- merge.default(parent_completed_all_both1, parent_completed_all_fu2, all=TRUE) %>%
  filter(!is.na(p_crisis_base_tot)) %>% filter(!is.na(p_crisis_fu_tot)) %>% filter(!is.na(p_crisis_fu2_tot))
parent_completed_all_both_num2 <- parent_completed_all_both2 %>% nrow() %>% as.numeric()
# # child 
child_completed_all_fu2 <- child_completed_all_fu2 %>% rename(s_mfq_fu2_tot="s_mfq_tot") %>% rename(s_scaredshort_fu2_tot="s_scaredshort_tot") %>% 
  rename(s_crisis_fu2_tot="s_crisis_fu_tot")
child_completed_all_both2 <- merge.default(child_completed_all_both1, child_completed_all_fu2, all=TRUE) %>%
  filter(!is.na(s_crisis_base_tot)) %>% filter(!is.na(s_crisis_fu_tot)) %>% filter(!is.na(s_crisis_fu2_tot))
child_completed_all_both_num2 <- child_completed_all_both2 %>% nrow() %>% as.numeric()
##### crisis baseline + followup completed, crisis only
# parent
parent_completed_crisis_fu2 <- parent_completed_crisis_fu2 %>% rename(p_crisis_fu2_tot="p_crisis_fu_tot")
parent_completed_crisis_both2 <- merge.default(parent_completed_crisis_both1, parent_completed_crisis_fu2, all=TRUE) %>%
  filter(!is.na(p_crisis_fu_tot)) %>% filter(!is.na(p_crisis_fu2_tot))
parent_completed_crisis_both_num2 <- parent_completed_crisis_both2 %>% nrow() %>% as.numeric()
# child
child_completed_crisis_fu2 <- child_completed_crisis_fu2 %>% rename(s_crisis_fu2_tot="s_crisis_fu_tot")
child_completed_crisis_both2 <- merge.default(child_completed_crisis_both1, child_completed_crisis_fu2, all=TRUE) %>%
  filter(!is.na(s_crisis_fu_tot)) %>% filter(!is.na(s_crisis_fu2_tot))
child_completed_crisis_both_num2 <- child_completed_crisis_both2 %>% nrow() %>% as.numeric()
##### crisis baseline + followup completed, all measures (third follow up)
# parent
parent_completed_all_fu3 <- parent_completed_all_fu3 %>% rename(p_mfq_fu3_tot="p_mfq_tot") %>% rename(p_scaredshort_fu3_tot="p_scaredshort_tot") %>% 
  rename(p_crisis_fu3_tot="p_crisis_fu_tot")
parent_completed_all_both3 <- merge.default(parent_completed_all_both2, parent_completed_all_fu3, all=TRUE) %>%
  filter(!is.na(p_crisis_base_tot)) %>% filter(!is.na(p_crisis_fu_tot)) %>% filter(!is.na(p_crisis_fu3_tot))
parent_completed_all_both_num3 <- parent_completed_all_both3 %>% nrow() %>% as.numeric()
# # child 
child_completed_all_fu3 <- child_completed_all_fu3 %>% rename(s_mfq_fu3_tot="s_mfq_tot") %>% rename(s_scaredshort_fu3_tot="s_scaredshort_tot") %>% 
  rename(s_crisis_fu3_tot="s_crisis_fu_tot")
child_completed_all_both3 <- merge.default(child_completed_all_both2, child_completed_all_fu3, all=TRUE) %>%
  filter(!is.na(s_crisis_base_tot)) %>% filter(!is.na(s_crisis_fu_tot)) %>% filter(!is.na(s_crisis_fu3_tot))
child_completed_all_both_num3 <- child_completed_all_both3 %>% nrow() %>% as.numeric()
##### crisis baseline + followup completed, crisis only
# parent
parent_completed_crisis_fu3 <- parent_completed_crisis_fu3 %>% rename(p_crisis_fu3_tot="p_crisis_fu_tot")
parent_completed_crisis_both3 <- merge.default(parent_completed_crisis_both2, parent_completed_crisis_fu3, all=TRUE) %>%
  filter(!is.na(p_crisis_fu_tot)) %>% filter(!is.na(p_crisis_fu3_tot))
parent_completed_crisis_both_num3 <- parent_completed_crisis_both3 %>% nrow() %>% as.numeric()
# child
child_completed_crisis_fu3 <- child_completed_crisis_fu3 %>% rename(s_crisis_fu3_tot="s_crisis_fu_tot")
child_completed_crisis_both3 <- merge.default(child_completed_crisis_both2, child_completed_crisis_fu3, all=TRUE) %>%
  filter(!is.na(s_crisis_fu_tot)) %>% filter(!is.na(s_crisis_fu3_tot))
child_completed_crisis_both_num3 <- child_completed_crisis_both3 %>% nrow() %>% as.numeric()
##### crisis baseline + followup completed, all measures (forth follow up)
# parent
parent_completed_all_fu4 <- parent_completed_all_fu4 %>% rename(p_mfq_fu4_tot="p_mfq_tot") %>% rename(p_scaredshort_fu4_tot="p_scaredshort_tot") %>% 
  rename(p_crisis_fu4_tot="p_crisis_fu_tot")
parent_completed_all_both4 <- merge.default(parent_completed_all_both3, parent_completed_all_fu4, all=TRUE) %>%
  filter(!is.na(p_crisis_base_tot)) %>% filter(!is.na(p_crisis_fu_tot)) %>% filter(!is.na(p_crisis_fu4_tot))
parent_completed_all_both_num4 <- parent_completed_all_both4 %>% nrow() %>% as.numeric()
# # child 
child_completed_all_fu4 <- child_completed_all_fu4 %>% rename(s_mfq_fu4_tot="s_mfq_tot") %>% rename(s_scaredshort_fu4_tot="s_scaredshort_tot") %>% 
  rename(s_crisis_fu4_tot="s_crisis_fu_tot")
child_completed_all_both4 <- merge.default(child_completed_all_both3, child_completed_all_fu4, all=TRUE) %>%
  filter(!is.na(s_crisis_base_tot)) %>% filter(!is.na(s_crisis_fu_tot)) %>% filter(!is.na(s_crisis_fu4_tot))
child_completed_all_both_num4 <- child_completed_all_both4 %>% nrow() %>% as.numeric()
##### crisis baseline + followup completed, crisis only
# parent
parent_completed_crisis_fu4 <- parent_completed_crisis_fu4 %>% rename(p_crisis_fu4_tot="p_crisis_fu_tot")
parent_completed_crisis_both4 <- merge.default(parent_completed_crisis_both3, parent_completed_crisis_fu4, all=TRUE) %>%
  filter(!is.na(p_crisis_fu_tot)) %>% filter(!is.na(p_crisis_fu4_tot))
parent_completed_crisis_both_num4 <- parent_completed_crisis_both4 %>% nrow() %>% as.numeric()
# child
child_completed_crisis_fu4 <- child_completed_crisis_fu4 %>% rename(s_crisis_fu4_tot="s_crisis_fu_tot")
child_completed_crisis_both4 <- merge.default(child_completed_crisis_both3, child_completed_crisis_fu4, all=TRUE) %>%
  filter(!is.na(s_crisis_fu_tot)) %>% filter(!is.na(s_crisis_fu4_tot))
child_completed_crisis_both_num4 <- child_completed_crisis_both4 %>% nrow() %>% as.numeric()

##### crisis baseline + followup completed, all measures (fifth follow up)
# parent
parent_completed_all_fu5 <- parent_completed_all_fu5 %>% rename(p_mfq_fu5_tot="p_mfq_tot") %>% rename(p_scaredshort_fu5_tot="p_scaredshort_tot") %>% 
  rename(p_crisis_fu5_tot="p_crisis_fu_tot")
parent_completed_all_both5 <- merge.default(parent_completed_all_both4, parent_completed_all_fu5, all=TRUE) %>%
  filter(!is.na(p_crisis_base_tot)) %>% filter(!is.na(p_crisis_fu_tot)) %>% filter(!is.na(p_crisis_fu5_tot))
parent_completed_all_both_num5 <- parent_completed_all_both5 %>% nrow() %>% as.numeric()
# # child 
child_completed_all_fu5 <- child_completed_all_fu5 %>% rename(s_mfq_fu5_tot="s_mfq_tot") %>% rename(s_scaredshort_fu5_tot="s_scaredshort_tot") %>% 
  rename(s_crisis_fu5_tot="s_crisis_fu_tot")
child_completed_all_both5 <- merge.default(child_completed_all_both4, child_completed_all_fu5, all=TRUE) %>%
  filter(!is.na(s_crisis_base_tot)) %>% filter(!is.na(s_crisis_fu_tot)) %>% filter(!is.na(s_crisis_fu5_tot))
child_completed_all_both_num5 <- child_completed_all_both5 %>% nrow() %>% as.numeric()
##### crisis baseline + followup completed, crisis only
# parent
parent_completed_crisis_fu5 <- parent_completed_crisis_fu5 %>% rename(p_crisis_fu5_tot="p_crisis_fu_tot")
parent_completed_crisis_both5 <- merge.default(parent_completed_crisis_both4, parent_completed_crisis_fu5, all=TRUE) %>%
  filter(!is.na(p_crisis_fu_tot)) %>% filter(!is.na(p_crisis_fu5_tot))
parent_completed_crisis_both_num5 <- parent_completed_crisis_both5 %>% nrow() %>% as.numeric()
# child
child_completed_crisis_fu5 <- child_completed_crisis_fu5 %>% rename(s_crisis_fu5_tot="s_crisis_fu_tot")
child_completed_crisis_both5 <- merge.default(child_completed_crisis_both4, child_completed_crisis_fu5, all=TRUE) %>%
  filter(!is.na(s_crisis_fu_tot)) %>% filter(!is.na(s_crisis_fu5_tot))
child_completed_crisis_both_num5 <- child_completed_crisis_both5 %>% nrow() %>% as.numeric()


# combine these
all_table <- tibble(Respondant=c("Parent", "Child"), 
                    # Tot_contacted=c(parent_contacted, child_contacted),
                    Tot_agreed=c(parent_agreed, child_agreed), 
                    ALL_base_completed=c(parent_completed_all_base_num, child_completed_all_base_num), 
                    ALL_fu_completed=c(parent_completed_all_fu_num1, child_completed_all_fu_num1), 
                    ALL_fu2_completed=c(parent_completed_all_fu_num2, child_completed_all_fu_num2),
                    ALL_fu3_completed=c(parent_completed_all_fu_num3, child_completed_all_fu_num3),
                    ALL_fu4_completed=c(parent_completed_all_fu_num4, child_completed_all_fu_num4),
                    ALL_fu5_completed=c(parent_completed_all_fu_num5, child_completed_all_fu_num5),
                    ALL_both_completed=c(parent_completed_all_both_num1, child_completed_all_both_num1), 
                    ALL_both2_completed=c(parent_completed_all_both_num2, child_completed_all_both_num2),
                    ALL_both3_completed=c(parent_completed_all_both_num3, child_completed_all_both_num3),
                    ALL_both4_completed=c(parent_completed_all_both_num4, child_completed_all_both_num4),
                    ALL_both5_completed=c(parent_completed_all_both_num5, child_completed_all_both_num5)) %>%
  # mutate(Agreed_percent = (Tot_agreed/Tot_contacted)*100) %>% mutate(Agreed_percent=round(Agreed_percent, digits=2)) %>% 
  mutate(All_base_percent = (ALL_base_completed/Tot_agreed)*100) %>%
  mutate(All_fu_percent = (ALL_fu_completed/Tot_agreed)*100) %>% mutate(All_both_percent = (ALL_both_completed/Tot_agreed)*100) %>% 
  mutate(All_fu2_percent = (ALL_fu2_completed/Tot_agreed)*100) %>% mutate(All_both2_percent = (ALL_both2_completed/Tot_agreed)*100) %>% 
  mutate(All_fu3_percent = (ALL_fu3_completed/Tot_agreed)*100) %>% mutate(All_both3_percent = (ALL_both3_completed/Tot_agreed)*100) %>%
  mutate(All_fu4_percent = (ALL_fu4_completed/Tot_agreed)*100) %>% mutate(All_both4_percent = (ALL_both4_completed/Tot_agreed)*100) %>%
  mutate(All_fu5_percent = (ALL_fu5_completed/Tot_agreed)*100) %>% mutate(All_both5_percent = (ALL_both5_completed/Tot_agreed)*100) %>%
  mutate(All_base_percent=round(All_base_percent, digits=2)) %>% 
  mutate(All_fu_percent=round(All_fu_percent, digits=2)) %>% mutate(All_both_percent=round(All_both_percent, digits=2)) %>% 
  mutate(All_fu2_percent=round(All_fu2_percent, digits=2)) %>% mutate(All_both2_percent=round(All_both2_percent, digits=2)) %>%
  mutate(All_fu3_percent=round(All_fu3_percent, digits=2)) %>% mutate(All_both3_percent=round(All_both3_percent, digits=2)) %>%
  mutate(All_fu4_percent=round(All_fu4_percent, digits=2)) %>% mutate(All_both4_percent=round(All_both4_percent, digits=2)) %>%
  mutate(All_fu5_percent=round(All_fu5_percent, digits=2)) %>% mutate(All_both5_percent=round(All_both5_percent, digits=2)) %>%
  select(Respondant, Tot_agreed, ALL_base_completed, All_base_percent, # Tot_contacted, Agreed_percent, 
    ALL_fu_completed, All_fu_percent, ALL_fu2_completed, All_fu2_percent, ALL_fu3_completed, All_fu3_percent, ALL_fu4_completed, All_fu4_percent, ALL_fu5_completed, All_fu5_percent,ALL_both_completed, All_both_percent, ALL_both2_completed, All_both2_percent, ALL_both3_completed, All_both3_percent, ALL_both4_completed, All_both4_percent, ALL_both5_completed, All_both5_percent)

crisis_table <- tibble(Respondant=c("Parent", "Child"), 
                       # Tot_contacted=c(parent_contacted, child_contacted),
                       Tot_agreed=c(parent_agreed, child_agreed), 
                       CRISIS_base_completed=c(parent_completed_crisis_base_num, child_completed_crisis_base_num),
                       CRISIS_fu_completed=c(parent_completed_crisis_fu_num1, child_completed_crisis_fu_num1), 
                       CRISIS_fu2_completed=c(parent_completed_crisis_fu_num2, child_completed_crisis_fu_num2), 
                       CRISIS_fu3_completed=c(parent_completed_crisis_fu_num3, child_completed_crisis_fu_num3), 
                       CRISIS_fu4_completed=c(parent_completed_crisis_fu_num4, child_completed_crisis_fu_num4),
                       CRISIS_fu5_completed=c(parent_completed_crisis_fu_num5, child_completed_crisis_fu_num5),
                       CRISIS_both_completed=c(parent_completed_crisis_both_num1, child_completed_crisis_both_num1), 
                       CRISIS_both2_completed=c(parent_completed_crisis_both_num2, child_completed_crisis_both_num2),
                       CRISIS_both3_completed=c(parent_completed_crisis_both_num3, child_completed_crisis_both_num3),
                       CRISIS_both4_completed=c(parent_completed_crisis_both_num4, child_completed_crisis_both_num4),
                       CRISIS_both5_completed=c(parent_completed_crisis_both_num5, child_completed_crisis_both_num5)) %>% 
  # mutate(Agreed_percent = (Tot_agreed/Tot_contacted)*100) %>% 
  mutate(CRISIS_base_percent = (CRISIS_base_completed/Tot_agreed)*100) %>%
  mutate(CRISIS_fu_percent = (CRISIS_fu_completed/Tot_agreed)*100) %>% mutate(CRISIS_both_percent = (CRISIS_both_completed/Tot_agreed)*100) %>%
  mutate(CRISIS_fu2_percent = (CRISIS_fu2_completed/Tot_agreed)*100) %>% mutate(CRISIS_both2_percent = (CRISIS_both2_completed/Tot_agreed)*100) %>%
  mutate(CRISIS_fu3_percent = (CRISIS_fu3_completed/Tot_agreed)*100) %>% mutate(CRISIS_both3_percent = (CRISIS_both3_completed/Tot_agreed)*100) %>%
  mutate(CRISIS_fu4_percent = (CRISIS_fu4_completed/Tot_agreed)*100) %>% mutate(CRISIS_both4_percent = (CRISIS_both4_completed/Tot_agreed)*100) %>%
  mutate(CRISIS_fu5_percent = (CRISIS_fu5_completed/Tot_agreed)*100) %>% mutate(CRISIS_both5_percent = (CRISIS_both5_completed/Tot_agreed)*100) %>%
  # mutate(Agreed_percent=round(Agreed_percent, digits=2)) %>% 
  mutate(CRISIS_base_percent=round(CRISIS_base_percent, digits=2)) %>% 
  mutate(CRISIS_fu_percent=round(CRISIS_fu_percent, digits=2)) %>% mutate(CRISIS_both_percent=round(CRISIS_both_percent, digits=2)) %>% 
  mutate(CRISIS_fu2_percent=round(CRISIS_fu2_percent, digits=2)) %>% mutate(CRISIS_both2_percent=round(CRISIS_both2_percent, digits=2)) %>% 
  mutate(CRISIS_fu3_percent=round(CRISIS_fu3_percent, digits=2)) %>% mutate(CRISIS_both3_percent=round(CRISIS_both3_percent, digits=2)) %>% 
  mutate(CRISIS_fu4_percent=round(CRISIS_fu4_percent, digits=2)) %>% mutate(CRISIS_both4_percent=round(CRISIS_both4_percent, digits=2)) %>% 
  mutate(CRISIS_fu5_percent=round(CRISIS_fu5_percent, digits=2)) %>% mutate(CRISIS_both5_percent=round(CRISIS_both5_percent, digits=2)) %>% 
  select(Respondant, Tot_agreed, CRISIS_base_completed, CRISIS_base_percent, CRISIS_fu_completed, CRISIS_fu_percent, # Tot_contacted, Agreed_percent,
         CRISIS_fu2_completed, CRISIS_fu2_percent, CRISIS_fu3_completed, CRISIS_fu3_percent, CRISIS_fu4_completed, CRISIS_fu4_percent,CRISIS_fu5_completed, CRISIS_fu5_percent, 
    CRISIS_both_completed, CRISIS_both_percent, CRISIS_both2_completed, CRISIS_both2_percent, CRISIS_both3_completed, CRISIS_both3_percent,
    CRISIS_both4_completed, CRISIS_both4_percent,CRISIS_both5_completed, CRISIS_both5_percent)

```

<!-- *** -->

<!-- ##### Agreed to participate: -->
<!-- ### -->

```{r echo=FALSE, warning=FALSE, message=FALSE}

# all_table %>% select(-ALL_base_completed:-All_both3_percent) %>% 
#   kable(., col.names = c("Respondant", "Total Contacted", "Total Agreed to Participate", "%")) %>% 
#   kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

```

***

##### Completed all measures (MFQ, SCARED (short) & CRISIS): 
### 

Each timepoint separately:

```{r echo=FALSE, warning=FALSE, message=FALSE}

all_table %>% # select(-Tot_contacted:-Agreed_percent) %>% 
  select(Respondant:All_fu5_percent) %>% 
  kable(., col.names = c("Respondant", "Total agreed", "Completed baseline", "%", "Completed follow up 1", "%", "Completed follow up 2", "%", 
    "Completed follow up 3", "%", "Completed follow up 4", "%","Completed follow up 5", "%")) %>% 
  kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

```

Completing all timepoints:

```{r echo=FALSE, warning=FALSE, message=FALSE}

all_table %>% # select(-Tot_contacted:-Agreed_percent) %>% 
  select(Respondant, Tot_agreed, ALL_both_completed:All_both5_percent) %>% 
  kable(., col.names = c("Respondant", "Total agreed", "Completed baseline & follow up 1", "%", "Completed baseline & follow ups 1 & 2", "%", 
    "Completed baseline & follow ups 1-3", "%", "Completed baseline & follow ups 1-4", "%","Completed baseline & follow ups 1-5", "%")) %>% 
  kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

```

***

##### Completed CRISIS: 
###

Each timepoint separately:

```{r echo=FALSE, warning=FALSE, message=FALSE}

crisis_table %>% # select(-Tot_contacted:-Agreed_percent) %>% 
  select(Respondant:CRISIS_fu5_percent) %>% 
  kable(., col.names = c("Respondant", "Total agreed", "Completed CRISIS: baseline", "%", "Completed CRISIS: follow up 1", "%", "Completed CRISIS: follow up 2", "%",
    "Completed CRISIS: follow up 3", "%", "Completed CRISIS: follow up 4", "%", "Completed CRISIS: follow up 5", "%")) %>% 
  kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

```

Completing all timepoints:

```{r echo=FALSE, warning=FALSE, message=FALSE}

crisis_table %>% # select(-Tot_contacted:-Agreed_percent) %>% 
  select(Respondant, Tot_agreed, CRISIS_both_completed:CRISIS_both5_percent) %>% 
  kable(., col.names = c("Respondant", "Total agreed", "Completed CRISIS: baseline & follow up 1", "%", "Completed CRISIS: baseline & follow ups 1 & 2", "%",
    "Completed CRISIS: baseline & follow ups 1-3", "%", "Completed CRISIS: baseline & follow ups 1-4", "%", "Completed CRISIS: baseline & follow ups 1-5", "%")) %>% 
  kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

```

```{r echo=FALSE, warning=FALSE, message=FALSE, results="hide" }

##### New method of putting together the dataset: 
##### Includes march MFQs & SCAREDS
##### Pre-covid = last timepoint before March 2020
##### This is the apporach used to put together the
##### dataset for Argyris' 08-21-2020 presentation. 
##### Note: older code used is saved at the bottom 
##### of this script & commented out 

# COVID measures ----------------------------------------------------------

s_scaredshortnames=names(Psychometrics_treatment %>% select("s_scaredshort_24_no_reason", "s_scaredshort_25_alone_at_home","s_scaredshort_28_worry_too_much", "s_scaredshort_36_go_to_school","s_scaredshort_41_shy"))
s_scaredlongnames=gsub("scaredshort","scared",s_scaredshortnames)
p_scaredlongnames=gsub("s_","p_",s_scaredlongnames)
Psychometrics_treatment <- Psychometrics_treatment %>%
  mutate(s_scaredshort_tot_from_long=round(Psychometrics_treatment %>% select(matches(s_scaredlongnames)) %>% rowSums(na.rm=FALSE), digits=0)) %>%
  mutate(p_scaredshort_tot_from_long=round(Psychometrics_treatment %>% select(matches(p_scaredlongnames)) %>% rowSums(na.rm=FALSE), digits=0))

s_measures_completed <- Psychometrics_treatment %>% 
  select(Initials, SDAN, PLUSID, Participant_Type2, SEX, Age_at_visit, IRTA_tracker, Clinical_Visit_Date, Clinical_Visit_Type, c_ksadsdx_primary_dx, c_ksadsdx_dx_detailed, 
    s_mfq1w_tot, s_mfq1w_date, s_mfq_tot, s_mfq_date, s_scared_tot, s_scared_date, s_scaredshort_tot, s_scaredshort_date, s_scaredshort_tot_from_long, matches("s_crisis_"), s_covid19_date) %>%
  filter(s_crisis_base_date > "2020-03-17" | s_crisis_fu_date > "2020-03-17" | s_covid19_date > "2020-03-17") %>% 
  select(-matches("_TDiff"), -matches("_complete"), -matches("_source"))
p_measures_completed <- Psychometrics_treatment %>% 
  select(Initials, SDAN, PLUSID, Participant_Type2, SEX, Age_at_visit, IRTA_tracker, Clinical_Visit_Date, Clinical_Visit_Type, c_ksadsdx_primary_dx, c_ksadsdx_dx_detailed, 
    p_mfq1w_tot, p_mfq1w_date, p_mfq_tot, p_mfq_date, p_scared_tot, p_scared_date, p_scaredshort_tot, p_scaredshort_date, p_scaredshort_tot_from_long, matches("p_crisis_"), s_covid19_date) %>%
  filter(p_crisis_base_date > "2020-03-17" | p_crisis_fu_date > "2020-03-17" | s_covid19_date > "2020-03-17") %>% 
  select(-matches("_TDiff"), -matches("_complete"), -matches("_source"))

measures_completed <- merge.default(s_measures_completed, p_measures_completed, all = TRUE)
num_variables <- measures_completed %>% select(matches("_tot")) %>% colnames()
measures_completed[num_variables] <- lapply(measures_completed[num_variables], as.numeric)

measures_completed$Clinical_Visit_Date <- as.Date(measures_completed$Clinical_Visit_Date)
measures_completed$s_mfq_tot <- coalesce(measures_completed$s_mfq_tot, measures_completed$s_mfq1w_tot) %>% round(., digits = 0)
measures_completed$s_mfq_date <- coalesce(measures_completed$s_mfq_date, measures_completed$s_mfq1w_date)
measures_completed$p_mfq_tot <- coalesce(measures_completed$p_mfq_tot, measures_completed$p_mfq1w_tot) %>% round(., digits = 0)
measures_completed$p_mfq_date <- coalesce(measures_completed$p_mfq_date, measures_completed$p_mfq1w_date)

base_names <- measures_completed %>% select(matches("_crisis_base_")) %>% colnames() %>% as.data.frame() %>% rename(Base = ".")
fu_names <- measures_completed %>% select(matches("_crisis_fu_")) %>% colnames() %>% as.data.frame() %>% rename(FU = ".")
crisis_merge_names <- cbind(base_names, fu_names) %>% mutate_all(as.character)

for(i in seq_len(nrow(crisis_merge_names))) {
  iter <- as.numeric(i)
  # iter=104
  base <- crisis_merge_names[iter,1] %>% as.character
  fu <- crisis_merge_names[iter,2] %>% as.character
  b <- which(colnames(measures_completed)==eval(base)) %>% as.numeric()
  f <- which(colnames(measures_completed)==eval(fu)) %>% as.numeric()
  new <- gsub("_base_", "_", base, fixed = TRUE)
  
  measures_completed$temp <- coalesce(measures_completed[[b]], measures_completed[[f]])
  names(measures_completed)[names(measures_completed) == "temp"] <- (paste0(new))
}

measures_completed <- measures_completed %>% group_by(Initials) %>% mutate(id = row_number()) %>% ungroup()
measures_completed$row_label <- paste("covid_t", measures_completed$id, sep = "")

measures_completed_combined <- measures_completed %>% 
  select(Initials, SDAN, PLUSID, row_label, Participant_Type2, SEX, Age_at_visit, IRTA_tracker, Clinical_Visit_Date, Clinical_Visit_Type,
    c_ksadsdx_primary_dx, c_ksadsdx_dx_detailed, s_mfq_tot, s_mfq_date, s_scared_tot, s_scared_date, s_scaredshort_tot, s_scaredshort_date,s_scaredshort_tot_from_long, 
    p_mfq_tot, p_mfq_date, p_scared_tot, p_scared_date, p_scaredshort_tot, p_scaredshort_date, p_scaredshort_tot_from_long, matches("s_crisis_"), matches("p_crisis_")) %>% 
  select(-matches("_crisis_base_"), -matches("_crisis_fu_"))

# Pre-COVID ---------------------------------------------------------------

Psychometrics_treatment[num_variables] <- lapply(Psychometrics_treatment[num_variables], as.numeric)

### MFQ
# self
smfq_tminus1_long <- Psychometrics_treatment %>% select(Initials, SDAN, PLUSID, Participant_Type2, SEX, Age_at_visit, IRTA_tracker, Clinical_Visit_Date, Clinical_Visit_Type,
  c_ksadsdx_primary_dx, c_ksadsdx_dx_detailed, s_mfq1w_tot, s_mfq_tot, s_mfq1w_date, s_mfq_date) %>% 
  filter(!is.na(s_mfq1w_tot) | !is.na(s_mfq_tot)) 
smfq_tminus1_long$s_mfq_tot <- coalesce(smfq_tminus1_long$s_mfq_tot, smfq_tminus1_long$s_mfq1w_tot) %>% round(., digits = 0)
smfq_tminus1_long$s_mfq_date <- coalesce(smfq_tminus1_long$s_mfq_date, smfq_tminus1_long$s_mfq1w_date)
smfq_tminus1_long <- smfq_tminus1_long %>% filter(s_mfq_date < "2020-03-17") %>% group_by(Initials) %>% 
  arrange(desc(s_mfq_date)) %>% slice(1) %>% ungroup() %>% select(-s_mfq1w_date, -s_mfq1w_tot) %>% distinct(., .keep_all = TRUE)
# parent
pmfq_tminus1_long <- Psychometrics_treatment %>% select(Initials, SDAN, PLUSID, Participant_Type2, SEX, Age_at_visit, IRTA_tracker, Clinical_Visit_Date, Clinical_Visit_Type,
  c_ksadsdx_primary_dx, c_ksadsdx_dx_detailed, p_mfq1w_tot, p_mfq_tot, p_mfq1w_date, p_mfq_date) %>% 
  filter(!is.na(p_mfq1w_tot) | !is.na(p_mfq_tot)) 
pmfq_tminus1_long$p_mfq_tot <- coalesce(pmfq_tminus1_long$p_mfq_tot, pmfq_tminus1_long$p_mfq1w_tot) %>% round(., digits = 0)
pmfq_tminus1_long$p_mfq_date <- coalesce(pmfq_tminus1_long$p_mfq_date, pmfq_tminus1_long$p_mfq1w_date)
pmfq_tminus1_long <- pmfq_tminus1_long %>% filter(p_mfq_date < "2020-03-17") %>% group_by(Initials) %>% 
  arrange(desc(p_mfq_date)) %>% slice(1) %>% ungroup() %>% select(-p_mfq1w_date, -p_mfq1w_tot) %>% distinct(., .keep_all = TRUE)

### SCARED
# self
sscared_tminus1_long <- Psychometrics_treatment %>% select(Initials, SDAN, PLUSID, Participant_Type2, SEX, Age_at_visit,  IRTA_tracker, Clinical_Visit_Date, Clinical_Visit_Type,
  c_ksadsdx_primary_dx, c_ksadsdx_dx_detailed, s_scared_tot, s_scared_date, s_scaredshort_tot_from_long) %>% 
  filter(!is.na(s_scared_tot)) %>% mutate(s_scared_tot = round(s_scared_tot, digits = 0)) %>% filter(s_scared_date < "2020-03-17") %>% 
  group_by(Initials) %>% arrange(desc(s_scared_date)) %>% slice(1) %>% ungroup()
pscared_tminus1_long <- Psychometrics_treatment %>% select(Initials, SDAN, PLUSID, Participant_Type2, SEX, Age_at_visit,  IRTA_tracker, Clinical_Visit_Date, Clinical_Visit_Type,
  c_ksadsdx_primary_dx, c_ksadsdx_dx_detailed, p_scared_tot, p_scared_date, p_scaredshort_tot_from_long) %>% 
  filter(!is.na(p_scared_tot)) %>% mutate(p_scared_tot = round(p_scared_tot, digits = 0)) %>% filter(p_scared_date < "2020-03-17") %>% 
  group_by(Initials) %>% arrange(desc(p_scared_date)) %>% slice(1) %>% ungroup()

### Combining these
# self
s_measures_combined_long <- merge.default(smfq_tminus1_long, sscared_tminus1_long, all=TRUE) %>% group_by(Initials) %>% arrange(Initials, desc(Clinical_Visit_Date)) %>% 
  fill(., s_mfq_tot:s_scared_date, .direction = "down") %>% fill(., s_mfq_tot:s_scaredshort_tot_from_long, .direction = "up") %>% slice(1) %>% ungroup() %>% 
  filter(Initials %in% measures_completed$Initials) %>% mutate(row_label = "pre-covid")
# parent
p_measures_combined_long <- merge.default(pmfq_tminus1_long, pscared_tminus1_long, all=TRUE) %>% group_by(Initials) %>% arrange(Initials, desc(Clinical_Visit_Date)) %>% 
  fill(., p_mfq_tot:p_scared_date, .direction = "down") %>% fill(., p_mfq_tot:p_scaredshort_tot_from_long, .direction = "up") %>% slice(1) %>% ungroup() %>% 
  filter(Initials %in% measures_completed$Initials) %>% mutate(row_label = "pre-covid")
# combining parent & child
measures_combined_long <- merge.default(s_measures_combined_long, p_measures_combined_long, all = TRUE) %>% 
  group_by(Initials) %>% arrange(Initials, desc(Clinical_Visit_Date)) %>% 
  fill(., s_mfq_tot:p_scared_date, .direction = "down") %>% fill(., s_mfq_tot:p_scaredshort_tot_from_long, .direction = "up") %>% slice(1) %>% ungroup() 

# Adding pre-COVID to COVID -----------------------------------------------

CRISIS_data_presentation_final1 <- merge.default(measures_completed_combined, measures_combined_long, all=TRUE)


CRISIS_data_presentation_final <- merge.default(measures_completed_combined, measures_combined_long, all=TRUE) %>% arrange(Initials, Clinical_Visit_Date) %>% 
  select(Initials, SDAN, PLUSID, row_label, Participant_Type2, SEX, Age_at_visit,  IRTA_tracker, Clinical_Visit_Date, Clinical_Visit_Type,
    c_ksadsdx_primary_dx, c_ksadsdx_dx_detailed, s_mfq_tot, s_mfq_date, s_scared_tot, s_scared_date, s_scaredshort_tot, s_scaredshort_date, s_scaredshort_tot_from_long, 
    p_mfq_tot, p_mfq_date, p_scared_tot, p_scared_date, p_scaredshort_tot, p_scaredshort_date, p_scaredshort_tot_from_long, matches("s_crisis_"), matches("p_crisis_"))

# SCARED short and long ----------------------------------------------------
#this used to take long values, and if not available put short, we switched it so it takes short by default and if not, items form long - changed 01-04-2021
CRISIS_data_presentation_final$s_scared_combined_tot <- coalesce(CRISIS_data_presentation_final$s_scaredshort_tot, CRISIS_data_presentation_final$s_scaredshort_tot_from_long)
CRISIS_data_presentation_final$s_scared_combined_date <- coalesce(CRISIS_data_presentation_final$s_scaredshort_date, CRISIS_data_presentation_final$s_scared_date)
CRISIS_data_presentation_final$p_scared_combined_tot <- coalesce(CRISIS_data_presentation_final$p_scaredshort_tot, CRISIS_data_presentation_final$p_scaredshort_tot_from_long)
CRISIS_data_presentation_final$p_scared_combined_date <- coalesce(CRISIS_data_presentation_final$p_scaredshort_date, CRISIS_data_presentation_final$p_scared_date)

rm(s_scaredshort_tot_from_long1,p_scaredshort_tot_from_long1)

# CRISIS subset for means & graphs -----------------------------------------

crisis_subset1 <- CRISIS_data_presentation_final %>% select(Initials, c_ksadsdx_primary_dx, row_label, s_crisis_3m_tot, s_crisis_3m_date) %>%
  filter(!is.na(s_crisis_3m_tot)) %>% arrange(Initials) %>% group_by(Initials) %>% slice(1) %>% ungroup() %>%
  rename(s_crisis_tot="s_crisis_3m_tot") %>% rename(s_crisis_date="s_crisis_3m_date") %>% mutate(row_label="pre-covid") %>% mutate(id="1")
crisis_subset2 <- CRISIS_data_presentation_final %>% select(Initials, c_ksadsdx_primary_dx, row_label, s_crisis_tot, s_crisis_date) %>%
  filter(!is.na(s_crisis_tot)) %>% arrange(Initials) %>% group_by(Initials) %>% slice(1) %>% ungroup() %>% mutate(row_label="baseline") %>% mutate(id="2")
crisis_subset3 <- CRISIS_data_presentation_final %>% select(Initials, c_ksadsdx_primary_dx, row_label, s_crisis_tot, s_crisis_date) %>%
  filter(!is.na(s_crisis_tot)) %>% arrange(Initials) %>% group_by(Initials) %>% filter(n()>1) %>% slice(2) %>% ungroup() %>% mutate(row_label="followup1") %>% mutate(id="3")
crisis_subset4 <- CRISIS_data_presentation_final %>% select(Initials, c_ksadsdx_primary_dx, row_label, s_crisis_tot, s_crisis_date) %>%
  filter(!is.na(s_crisis_tot)) %>% arrange(Initials) %>% group_by(Initials) %>% filter(n()>2) %>% slice(3) %>% ungroup() %>% mutate(row_label="followup2") %>% mutate(id="4")
crisis_subset5 <- CRISIS_data_presentation_final %>% select(Initials, c_ksadsdx_primary_dx, row_label, s_crisis_tot, s_crisis_date) %>%
  filter(!is.na(s_crisis_tot)) %>% arrange(Initials) %>% group_by(Initials) %>% filter(n()>3) %>% slice(4) %>% ungroup() %>% mutate(row_label="followup3") %>% mutate(id="5")
crisis_subset6 <- CRISIS_data_presentation_final %>% select(Initials, c_ksadsdx_primary_dx, row_label, s_crisis_tot, s_crisis_date) %>%
  filter(!is.na(s_crisis_tot)) %>% arrange(Initials) %>% group_by(Initials) %>% filter(n()>4) %>% slice(5) %>% ungroup() %>% mutate(row_label="followup4") %>% mutate(id="6")
crisis_subset7 <- CRISIS_data_presentation_final %>% select(Initials, c_ksadsdx_primary_dx, row_label, s_crisis_tot, s_crisis_date) %>%
  filter(!is.na(s_crisis_tot)) %>% arrange(Initials) %>% group_by(Initials) %>% filter(n()>5) %>% slice(6) %>% ungroup() %>% mutate(row_label="followup5") %>% mutate(id="7")
# crisis_subset8 <- CRISIS_data_presentation_final %>% select(Initials, c_ksadsdx_primary_dx, row_label, s_crisis_tot, s_crisis_date) %>%
#   filter(!is.na(s_crisis_tot)) %>% arrange(Initials) %>% group_by(Initials) %>% filter(n()>6) %>% slice(7) %>% ungroup() %>% mutate(row_label="followup6") %>% mutate(id="8")
# crisis_subset9 <- CRISIS_data_presentation_final %>% select(Initials, c_ksadsdx_primary_dx, row_label, s_crisis_tot, s_crisis_date) %>%
#   filter(!is.na(s_crisis_tot)) %>% arrange(Initials) %>% group_by(Initials) %>% filter(n()>6) %>% slice(7) %>% ungroup() %>% mutate(row_label="followup7") %>% mutate(id="9")

crisis_subset <- merge.default(crisis_subset1, crisis_subset2, all = TRUE) %>% merge.default(., crisis_subset3, all = TRUE) %>%
  merge.default(., crisis_subset4, all = TRUE) %>% merge.default(., crisis_subset5, all = TRUE) %>% merge.default(., crisis_subset6, all = TRUE) %>%
  merge.default(., crisis_subset7, all = TRUE) %>% filter(c_ksadsdx_primary_dx=="MDD" | c_ksadsdx_primary_dx=="Healthy")
# %>% merge.default(., crisis_subset8, all = TRUE) %>% merge.default(., crisis_subset9, all = TRUE)
crisis_subset$row_label <- as.factor(crisis_subset$row_label)
crisis_subset$row_label <- ordered(crisis_subset$row_label,
  levels = c("pre-covid", "baseline", "followup1",  "followup2",  "followup3",  "followup4",  "followup5"))

crisis_group_means <- crisis_subset %>% group_by(c_ksadsdx_primary_dx, id, row_label) %>%
  summarise(s_crisis_mean=mean(s_crisis_tot), s_crisis_sd=sd(s_crisis_tot), s_crisis_N=n()) %>%
  mutate(s_crisis_mean=round(s_crisis_mean, digit=2), s_crisis_sd=round(s_crisis_sd, digit=2)) %>% ungroup()

# MFQ subset for means & graphs ------------------------------------------

mfq_subset <- CRISIS_data_presentation_final %>% filter(c_ksadsdx_primary_dx=="MDD" | c_ksadsdx_primary_dx=="Healthy") %>% 
  select(Initials, c_ksadsdx_primary_dx, row_label, s_mfq_tot, s_mfq_date) %>% filter(!is.na(s_mfq_tot)) 
mfq_subset$row_label <- as.factor(mfq_subset$row_label)
mfq_subset$row_label <- ordered(mfq_subset$row_label,
  levels = c("pre-covid", "covid_t1",  "covid_t2",  "covid_t3",  "covid_t4",  "covid_t5",  "covid_t6" ,  "covid_t7", "covid_t8"))
mfq_group_means <- mfq_subset %>% group_by(c_ksadsdx_primary_dx, row_label) %>%
  summarise(s_mfq_mean=mean(s_mfq_tot), s_mfq_sd=sd(s_mfq_tot), s_mfq_N=n()) %>%
  mutate(s_mfq_mean=round(s_mfq_mean, digit=2), s_mfq_sd=round(s_mfq_sd, digit=2)) %>% ungroup()

# Data for MFQ spaghetti plots ------------------------------------------

measures_all <- Psychometrics_treatment %>% filter(Clinical_Visit_Date >= "2016-10-01") %>%
  select(Initials, SDAN, PLUSID, Participant_Type2, IRTA_tracker, Clinical_Visit_Date, Clinical_Visit_Type, SEX, Age_at_visit,
    c_ksadsdx_primary_dx, c_ksadsdx_dx_detailed, s_mfq1w_tot, s_mfq1w_date, s_mfq_tot, s_mfq_date, p_mfq1w_tot, p_mfq1w_date, p_mfq_tot, p_mfq_date) %>%
  rename(Age = "Age_at_visit") %>% mutate(Age = round(Age, digits = 0))
measures_all$s_mfq_tot <- coalesce(measures_all$s_mfq_tot, measures_all$s_mfq1w_tot) %>% round(., digits = 0)
measures_all$p_mfq_tot <- coalesce(measures_all$p_mfq_tot, measures_all$p_mfq1w_tot) %>% round(., digits = 0)
measures_all$s_mfq_date <- coalesce(measures_all$s_mfq_date, measures_all$s_mfq1w_date)
measures_all$p_mfq_date <- coalesce(measures_all$p_mfq_date, measures_all$p_mfq1w_date)
measures_all <- measures_all %>% select(-s_mfq1w_tot, -p_mfq1w_tot, -s_mfq1w_date, -p_mfq1w_date)

split1 <- colsplit(measures_all$Clinical_Visit_Date, "-", names = c("year", "month", "day"))
measures_all <- cbind(measures_all, split1)
measures_all <- measures_all %>% mutate(day2 = ifelse(day < 7, 1, ifelse((day >= 7 & day <14), 7, ifelse((day >=14 & day < 21), 14, ifelse(day >=21, 21, 0)))))
measures_all$Clinical_Visit_Date3c <- as.Date(paste(measures_all$year, measures_all$month, measures_all$day2, sep="-"))
measures_all <- measures_all %>% select(Initials:IRTA_tracker, matches("Clinical_Visit_Date"), year, month, day, day2, Clinical_Visit_Type:p_mfq_date)

s_mfq_subset_all <- measures_all %>% filter(c_ksadsdx_primary_dx=="MDD" | c_ksadsdx_primary_dx=="Healthy") %>% filter(!is.na(s_mfq_tot)) %>% 
  select(Initials, Clinical_Visit_Date, Clinical_Visit_Date3c, c_ksadsdx_primary_dx, s_mfq_tot)
mfq_all_group_means <- s_mfq_subset_all %>% group_by(c_ksadsdx_primary_dx, Clinical_Visit_Date3c) %>%
  summarise(s_mfq_mean=mean(s_mfq_tot), s_mfq_sd=sd(s_mfq_tot), s_mfq_N=n()) %>%
  mutate(s_mfq_mean=round(s_mfq_mean, digit=2), s_mfq_sd=round(s_mfq_sd, digit=2)) %>% ungroup()

s_mfq_5m_precovid <- measures_all %>% filter(c_ksadsdx_primary_dx=="MDD" | c_ksadsdx_primary_dx=="Healthy") %>% filter(!is.na(s_mfq_tot)) %>%
  filter(Clinical_Visit_Date3c >= "2019-10-01") %>% select(Initials, Clinical_Visit_Date, Clinical_Visit_Date3c, c_ksadsdx_primary_dx, s_mfq_tot)
s_mfq_5m_precovid_group_means <- s_mfq_5m_precovid %>% group_by(c_ksadsdx_primary_dx, Clinical_Visit_Date3c) %>%
  summarise(s_mfq_mean=mean(s_mfq_tot), s_mfq_sd=sd(s_mfq_tot), s_mfq_N=n()) %>%
  mutate(s_mfq_mean=round(s_mfq_mean, digit=2), s_mfq_sd=round(s_mfq_sd, digit=2)) %>% ungroup()

s_mfq_since_covid <- measures_all %>% filter(c_ksadsdx_primary_dx=="MDD" | c_ksadsdx_primary_dx=="Healthy") %>% filter(!is.na(s_mfq_tot)) %>%
  filter(Clinical_Visit_Date3c >= "2020-03-01") %>% select(Initials, Clinical_Visit_Date, Clinical_Visit_Date3c, c_ksadsdx_primary_dx, s_mfq_tot)
s_mfq_since_covid_group_means <- s_mfq_since_covid %>% group_by(c_ksadsdx_primary_dx, Clinical_Visit_Date3c) %>%
  summarise(s_mfq_mean=mean(s_mfq_tot), s_mfq_sd=sd(s_mfq_tot), s_mfq_N=n()) %>%
  mutate(s_mfq_mean=round(s_mfq_mean, digit=2), s_mfq_sd=round(s_mfq_sd, digit=2)) %>% ungroup()

# SCARED subset for means & graphs ----------------------------------------

scared_subset <- CRISIS_data_presentation_final %>% filter(c_ksadsdx_primary_dx=="MDD" | c_ksadsdx_primary_dx=="Healthy") %>% 
  select(Initials, c_ksadsdx_primary_dx, row_label, s_scared_combined_tot, s_scared_combined_date) %>% filter(!is.na(s_scared_combined_tot)) 
scared_subset$row_label <- as.factor(scared_subset$row_label)
scared_subset$row_label <- ordered(scared_subset$row_label,
  levels = c("pre-covid", "covid_t1",  "covid_t2",  "covid_t3",  "covid_t4",  "covid_t5",  "covid_t6" ,  "covid_t7", "covid_t8"))
scared_group_means <- scared_subset %>% group_by(c_ksadsdx_primary_dx, row_label) %>%
  summarise(s_scared_mean=mean(s_scared_combined_tot), s_scared_sd=sd(s_scared_combined_tot), s_scared_N=n()) %>%
  mutate(s_scared_mean=round(s_scared_mean, digit=2), s_scared_sd=round(s_scared_sd, digit=2)) %>% ungroup()

```

***

##### CRISIS descriptives: 
###

```{r echo=FALSE, warning=FALSE, message=FALSE}

crisis_group_means$s_crisis_combined <- paste(crisis_group_means$s_crisis_mean, " (", crisis_group_means$s_crisis_sd, ")", sep="")
crisis_group_means_t <- crisis_group_means %>% 
  pivot_wider(., id_cols = c("id", "row_label"), names_from = "c_ksadsdx_primary_dx", values_from = c("s_crisis_combined", "s_crisis_N"))
crisis_group_means_t$Tot_N <- crisis_group_means_t %>% select(matches("_N_")) %>% rowSums(na.rm=TRUE)
crisis_group_means_t <- crisis_group_means_t %>% 
  select(id, row_label, s_crisis_combined_Healthy, s_crisis_N_Healthy, s_crisis_combined_MDD, s_crisis_N_MDD, Tot_N)

crisis_group_means_t %>% kable(., col.names = c("Time point", "Type", "Healthy: M (SD)", "N", "MDD: M (SD)", "N", "Overall N")) %>% 
  kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

```

***

##### CRISIS graph: individual lines + group mean by Dx
###

```{r echo=FALSE, warning=FALSE, message=FALSE}

ggplot() +
  geom_line(data = crisis_group_means, aes(x=row_label, y=s_crisis_mean, group=c_ksadsdx_primary_dx, color=c_ksadsdx_primary_dx), size=2) + 
  geom_line(data = crisis_subset, aes(x=row_label, y=s_crisis_tot, group=Initials, color=c_ksadsdx_primary_dx), alpha=0.25) +
  labs(x="\nTime point", y="CRISIS total\n") +
  # labs(title="Depression symptoms\n", x="\nTime point", y="CRISIS total\n") +
  scale_color_manual(values=c("#CC0000", "#0000CC")) +
  # scale_x_discrete(expand = c(0,0), limit = c("pre-covid", "baseline", "followup1", "followup2", "followup3", "followup4")) + 
  # scale_x_discrete(labels=c("Pre-covid", "March", "April", "May", "June", "July", "August") +
  theme_minimal() +
  guides(color=guide_legend("Diagnosis:"))

```

***

##### MFQ group means: 
###

```{r echo=FALSE, warning=FALSE, message=FALSE}

mfq_group_means$s_mfq_combined <- paste(mfq_group_means$s_mfq_mean, " (", mfq_group_means$s_mfq_sd, ")", sep="")
mfq_group_means_t <- mfq_group_means %>% 
  pivot_wider(., id_cols = c("row_label"), names_from = "c_ksadsdx_primary_dx", values_from = c("s_mfq_combined", "s_mfq_N"))
mfq_group_means_t$Tot_N <- mfq_group_means_t %>% select(matches("_N_")) %>% rowSums(na.rm=TRUE)
mfq_group_means_t <- mfq_group_means_t %>% 
  select(row_label, s_mfq_combined_Healthy, s_mfq_N_Healthy, s_mfq_combined_MDD, s_mfq_N_MDD, Tot_N)

mfq_group_means_t %>% kable(., col.names = c("Time point", "Healthy: M (SD)", "N", "MDD: M (SD)", "N", "Overall N")) %>% 
  kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

```

***

##### MFQ graph: individual lines + group mean by Dx
###

```{r echo=FALSE, warning=FALSE, message=FALSE}

ggplot() +
  geom_line(data=mfq_group_means, aes(x=row_label, y=s_mfq_mean, group=c_ksadsdx_primary_dx, color=c_ksadsdx_primary_dx), size=2) + 
  geom_line(data = mfq_subset, aes(x=row_label, y=s_mfq_tot, group=Initials, color=c_ksadsdx_primary_dx), alpha=0.25) +
  labs(x="\nTime point", y="MFQ total\n") +
  # labs(title="Depression symptoms\n", x="\nTime point", y="MFQ total\n") +
  scale_color_manual(values=c("#CC0000", "#0000CC")) +
  # scale_x_discrete(expand = c(0,0), limit = c("pre-covid", "baseline", "followup1", "followup2", "followup3", "followup4")) + 
  theme_minimal() +
  guides(color=guide_legend("Diagnosis:"))

```

##### ALTERNATIVE MFQ GRAPH: all timepoints in our study
###

```{r echo=FALSE, warning=FALSE, message=FALSE}

ggplot() +
  geom_line(data= mfq_all_group_means, aes(x=Clinical_Visit_Date3c, y=s_mfq_mean, group=c_ksadsdx_primary_dx, color=c_ksadsdx_primary_dx), size=0.5) +
  geom_line(data = s_mfq_subset_all, aes(x=Clinical_Visit_Date3c, y=s_mfq_tot, group=Initials, color=c_ksadsdx_primary_dx), alpha=0.25) +
  xlab ("\n") + ylab("Depression Score\n") + 
  labs(title = "\nDepressive symptoms trajectories since the beginning of our study\n") + 
  guides(color=guide_legend("Diagnosis:")) + 
  scale_color_manual(values=c("#CC0000", "#0000CC")) +
  scale_x_date(date_break = "4 months", date_labels = "%b") +
  geom_vline(xintercept=as.Date("2020-03-01"), size=1, colour="#000000") +
  geom_text(aes(x=as.Date("2020-03-01"), label="March 2020\n", y=30), colour="#000000", angle=90) + 
  ylim(0,40) +
  theme_minimal() +
  theme(axis.text=element_text(size=12), plot.title = element_text(size = 12, face = "bold"), 
    axis.title=element_text(size=12), legend.title = element_text(size = 12), legend.text = element_text(size = 12))

```

Limiting to measures collected from Oct 2019 - present: 

```{r echo=FALSE, warning=FALSE, message=FALSE}

ggplot() +
  geom_line(data = s_mfq_5m_precovid_group_means, aes(x=Clinical_Visit_Date3c, y=s_mfq_mean, group=c_ksadsdx_primary_dx, color=c_ksadsdx_primary_dx), size=0.5, na.rm=TRUE) +
  geom_line(data = s_mfq_5m_precovid, aes(x=Clinical_Visit_Date3c, y=s_mfq_tot, group=Initials, color=c_ksadsdx_primary_dx), alpha=0.25, na.rm=TRUE) +
  xlab ("\n") + ylab("Depression Score\n") + 
  labs(title = "\nDepressive symptoms trajectories before and during pandemic\n") + 
  guides(color=guide_legend("Diagnosis:")) + 
  scale_color_manual(values=c("#CC0000", "#0000CC")) +
  scale_x_date(date_break = "1 month", date_labels = "%b") +
  geom_vline(xintercept=as.Date("2020-03-01"), size=1, colour="#000000") +
  geom_text(aes(x=as.Date("2020-03-01"), label="March 2020\n", y=30), colour="#000000", angle=90) + 
  ylim(0,40) +
  theme_minimal() +
  theme(axis.text=element_text(size=12), plot.title = element_text(size = 12, face = "bold"), 
    axis.title=element_text(size=12), legend.title = element_text(size = 12), legend.text = element_text(size = 12))

```

Limiting to measures collected from March 2020 - present: 

```{r echo=FALSE, warning=FALSE, message=FALSE}

ggplot() +
  geom_line(data = s_mfq_since_covid_group_means, aes(x=Clinical_Visit_Date3c, y=s_mfq_mean, group=c_ksadsdx_primary_dx, color=c_ksadsdx_primary_dx), size=0.5, na.rm=TRUE) +
  geom_line(data = s_mfq_since_covid, aes(x=Clinical_Visit_Date3c, y=s_mfq_tot, group=Initials, color=c_ksadsdx_primary_dx), alpha=0.25, na.rm=TRUE) +
  xlab ("\n") + ylab("Depression Score\n") + 
  labs(title = "\nDepressive symptoms trajectories since pandemic\n") + 
  guides(color=guide_legend("Diagnosis:")) + 
  scale_color_manual(values=c("#CC0000", "#0000CC")) +
  scale_x_date(date_break = "1 month", date_labels = "%b") +
  geom_vline(xintercept=as.Date("2020-03-01"), size=1, colour="#000000") +
  geom_text(aes(x=as.Date("2020-03-01"), label="March 2020\n", y=30), colour="#000000", angle=90) + 
  ylim(0,40) +
  theme_minimal() +
  theme(axis.text=element_text(size=12), plot.title = element_text(size = 12, face = "bold"), 
    axis.title=element_text(size=12), legend.title = element_text(size = 12), legend.text = element_text(size = 12))

```

***

##### SCARED group means: 
###

```{r echo=FALSE, warning=FALSE, message=FALSE}

scared_group_means$s_scared_combined <- paste(scared_group_means$s_scared_mean, " (", scared_group_means$s_scared_sd, ")", sep="")
scared_group_means_t <- scared_group_means %>% 
  pivot_wider(., id_cols = c("row_label"), names_from = "c_ksadsdx_primary_dx", values_from = c("s_scared_combined", "s_scared_N"))
scared_group_means_t$Tot_N <- scared_group_means_t %>% select(matches("_N_")) %>% rowSums(na.rm=TRUE)
scared_group_means_t <- scared_group_means_t %>% select(row_label, s_scared_combined_Healthy, s_scared_N_Healthy, s_scared_combined_MDD, s_scared_N_MDD, Tot_N)

scared_group_means_t %>% kable(., col.names = c("Time point", "Healthy: M (SD)", "N", "MDD: M (SD)", "N", "Overall total")) %>% 
  kable_styling(position = "left", bootstrap_options = c("striped", "hover", "condensed"))

```

***

##### SCARED graph: individual lines + group mean by Dx
###

```{r echo=FALSE, warning=FALSE, message=FALSE}

ggplot() +
  geom_line(data=scared_group_means, aes(x=row_label, y=s_scared_mean, group=c_ksadsdx_primary_dx, color=c_ksadsdx_primary_dx), size=2) + 
  geom_line(data = scared_subset, aes(x=row_label, y=s_scared_combined_tot, group=Initials, color=c_ksadsdx_primary_dx), alpha=0.25) +
  labs(x="\nTime point", y="SCARED total\n") +
  # labs(title="Depression symptoms\n", x="\nTime point", y="SCARED total\n") +
  scale_color_manual(values=c("#CC0000", "#0000CC")) +
  # scale_x_discrete(expand = c(0,0), limit = c("pre-covid", "baseline", "followup1", "followup2", "followup3", "followup4")) + 
  theme_minimal() +
  guides(color=guide_legend("Diagnosis:"))

```

***

\pagebreak

```{r echo=FALSE, warning=FALSE, message=FALSE, results="hide" }

rm(list=ls(pattern="child_completed_"))
rm(list=ls(pattern="parent_completed_"))
rm(parent_agreed, child_agreed, all_table, crisis_table, measures_combined_long, base, fu, new, num_variables, 
  base_names, crisis_merge_names, fu_names, mfq_all_group_means, s_mfq_5m_precovid, s_mfq_5m_precovid_group_means,
  pscared_tminus1_long, pmfq_tminus1_long, smfq_tminus1_long, scared_group_means_t, scared_group_means, scared_subset, 
  mfq_group_means_t, mfq_group_means, mfq_subset, crisis_group_means_t, crisis_group_means, crisis_subset, crisis_subset1,
  sscared_tminus1_long, s_mfq_since_covid, s_mfq_since_covid_group_means, 
  crisis_subset2, crisis_subset3, crisis_subset4, crisis_subset5)

```

```{r echo=FALSE, warning=FALSE, message=FALSE, results="hide" }

##### Old method for putting toghether the dataset for analysis: 
##### Issue with this approach is that it does not include MFQs & SCAREDs 
##### that were collected in March during the time we were collecting 
##### the first COVID questionnaire. I have left this section in so that
##### you can put together the CRISIS dataset with a 'baseline' timepoint
##### (i.e. baseline = their first ever timepoint with us) and a pre-covid. 
# 
# measures_completed <- measures_completed %>% 
#   filter(!is.na(s_mfq_tot) | !is.na(s_scaredshort_tot) | !is.na(s_crisis_base_tot) | !is.na(s_crisis_fu_tot) |
#                         !is.na(p_mfq_tot) | !is.na(p_scaredshort_tot) | !is.na(p_crisis_base_tot) | !is.na(p_crisis_fu_tot))
# 
# smfq_tminus2_long <- Psychometrics_treatment %>% 
#   select(Initials, SDAN, PLUSID, Participant_Type2, IRTA_tracker, SEX, Age_at_visit,
#          c_ksadsdx_primary_dx, c_ksadsdx_dx_detailed, s_mfq1w_tot, s_mfq_tot, s_mfq1w_date, s_mfq_date) %>% rename(Age = "Age_at_visit") %>% 
#   filter(!is.na(s_mfq1w_tot) | !is.na(s_mfq_tot)) %>% mutate(Age = round(Age, digits = 0))
# smfq_tminus2_long$s_mfq_tot <- coalesce(smfq_tminus2_long$s_mfq_tot, smfq_tminus2_long$s_mfq1w_tot) %>% round(., digits = 0)
# smfq_tminus2_long$s_mfq_date <- coalesce(smfq_tminus2_long$s_mfq_date, smfq_tminus2_long$s_mfq1w_date) %>% round(., digits = 0)
# smfq_tminus2_long <- smfq_tminus2_long %>% filter(s_mfq_date <= "2020-03-11") %>% group_by(Initials) %>% 
#   arrange(s_mfq_date) %>% slice(1,n()) %>% distinct(., .keep_all = TRUE) %>% select(-s_mfq1w_date, -s_mfq1w_tot) %>% 
#   mutate(id = row_number()) %>% ungroup() %>% filter(Initials %in% measures_completed$Initials)
# 
# sscared_tminus2_long <- Psychometrics_treatment %>% 
#   select(Initials, SDAN, PLUSID, Participant_Type2, IRTA_tracker, SEX, Age_at_visit,
#          c_ksadsdx_primary_dx, c_ksadsdx_dx_detailed, s_scared_tot, s_scared_date) %>% rename(Age = "Age_at_visit") %>% 
#   filter(!is.na(s_scared_tot)) %>% mutate(s_scared_tot = round(s_scared_tot, digits = 0)) %>% mutate(Age = round(Age, digits = 0))
# sscared_tminus2_long <- sscared_tminus2_long %>% filter(s_scared_date <= "2020-03-11") %>% group_by(Initials) %>% 
#   arrange(s_scared_date) %>% slice(1,n()) %>% distinct(., .keep_all = TRUE) %>% mutate(id = row_number()) %>% 
#   ungroup() %>% filter(Initials %in% measures_completed$Initials)
# 
# pmfq_tminus2_long <- Psychometrics_treatment %>% 
#   select(Initials, SDAN, PLUSID, Participant_Type2, IRTA_tracker, SEX, Age_at_visit,
#          c_ksadsdx_primary_dx, c_ksadsdx_dx_detailed, p_mfq1w_tot, p_mfq_tot, p_mfq1w_date, p_mfq_date) %>% rename(Age = "Age_at_visit") %>% 
#   filter(!is.na(p_mfq1w_tot) | !is.na(p_mfq_tot)) %>% mutate(Age = round(Age, digits = 0))
# pmfq_tminus2_long$p_mfq_tot <- coalesce(pmfq_tminus2_long$p_mfq_tot, pmfq_tminus2_long$p_mfq1w_tot) %>% round(., digits = 0)
# pmfq_tminus2_long$p_mfq_date <- coalesce(pmfq_tminus2_long$p_mfq_date, pmfq_tminus2_long$p_mfq1w_date) %>% round(., digits = 0)
# pmfq_tminus2_long <- pmfq_tminus2_long %>% filter(p_mfq_date <= "2020-03-11") %>% group_by(Initials) %>% 
#   arrange(p_mfq_date) %>% slice(1,n()) %>% distinct(., .keep_all = TRUE) %>% mutate(id = row_number()) %>% ungroup() %>% 
#   select(-p_mfq1w_date, -p_mfq1w_tot) %>% filter(Initials %in% measures_completed$Initials)
# 
# pscared_tminus2_long <- Psychometrics_treatment %>% 
#   select(Initials, SDAN, PLUSID, Participant_Type2, IRTA_tracker, SEX, Age_at_visit,
#          c_ksadsdx_primary_dx, c_ksadsdx_dx_detailed, p_scared_tot, p_scared_date) %>% 
#   filter(!is.na(p_scared_tot)) %>% mutate(p_scared_tot = round(p_scared_tot, digits = 0)) %>% rename(Age = "Age_at_visit") %>% 
#   mutate(Age = round(Age, digits = 0))
# pscared_tminus2_long <- pscared_tminus2_long %>% filter(p_scared_date <= "2020-03-11") %>% group_by(Initials) %>% 
#   arrange(p_scared_date) %>% slice(1,n()) %>% distinct(., .keep_all = TRUE) %>% mutate(id = row_number()) %>% 
#   ungroup() %>% filter(Initials %in% measures_completed$Initials)
# 
# measures_combined_long <- merge.default(smfq_tminus2_long, sscared_tminus2_long, all=TRUE) %>% 
#   merge.default(., pmfq_tminus2_long, all=TRUE) %>% merge.default(., pscared_tminus2_long, all=TRUE) %>%
#   distinct(., .keep_all = TRUE)
# 
# crisis_final <- merge.default(measures_completed, measures_combined_long, all=TRUE) %>% rename(Sex = "SEX")
# crisis_final$row_label <- recode(crisis_final$id, `1`="baseline", `2`="pre-covid", 
#                           `3`="crisis_t1", `4`="crisis_t2", `5`="crisis_t3", `6`="crisis_t4", `7`="crisis_t5", `8`="crisis_t6", `9`="crisis_t7")
# crisis_final <- crisis_final %>% select(Initials, SDAN, PLUSID, IRTA_tracker, Sex, Age, c_ksadsdx_primary_dx, c_ksadsdx_dx_detailed, 
#                                         id, row_label, matches("_mfq"), matches("scared"), matches("s_crisis_"), matches("p_crisis"))

```
